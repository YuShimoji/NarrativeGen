# NarrativeGen: 動的生成システム仕様書 (v2.0)

## 1. 概要

本ドキュメントは、Unityプロジェクト「NarrativeGen」における、物語を動的に構築・進行させるためのコアシステム、特に`LogicEngine`の仕様と、それを制御するデータ形式について定義する。
初期構想にあった複雑な信念体系（Belief System）は、開発の過程でよりシンプルかつ堅牢な設計にリファクタリングされた。現在のバージョン(v2.0)は、**イベント駆動型**のナラティブ進行モデルを特徴とする。

## 2. コアコンポーネント: LogicEngine

`LogicEngine`は、物語の進行ロジック全体を管理するシングルトンのコンポーネントである。

### 主な責務

-   **物語の進行管理**: 命題（Proposition）のマスターリストと、割り込みタスク用のキュー（Narrative Queue）を管理し、次に提示すべき命題を決定する。
-   **知識ベースの管理**: プレイヤーがどの情報を知っているか（`_knownPropositionIds`）を追跡する。
-   **動的な物語拡張**: 新しい情報が提示された際に、関連する新しい物語の断片を動的にキューへ追加する。
-   **前提条件の判定**: ある命題を提示するために、プレイヤーが特定の情報を既に知っている必要があるか（`requires:`）を判定する。

### 動作フロー

`GetNextProposition()`メソッドが呼び出されるたびに、以下の優先順位で次に提示する命題を決定する。

1.  **割り込みキューの処理**: `_narrativeQueue`に処理すべき命題があれば、それを最優先で取り出す。
2.  **マスターリストの順次処理**: キューが空の場合、マスターリスト（タイムスタンプ順）を順番に進め、次に提示すべき命adeceを探索する。
3.  **条件判定**: 取り出した命題が提示可能か（未提示かつ前提条件を満たしているか）を判定し、可能であればそれを返す。条件を満たさない場合はスキップする。
4.  **物語の終端**: キューもマスターリストも空になった場合、物語の終わり（`null`）を返す。

## 3. ナラティブデータ形式 (CSV)

物語のデータは、`StreamingAssets/NarrativeData/`内のCSVファイルで管理される。`reason`フィールドに特殊なコマンドを記述することで、`LogicEngine`の動作を制御する。

### 基本構造

| id | timestamp | speaker | content                                | reason                             |
|----|-----------|---------|----------------------------------------|------------------------------------|
| 30 | 100       | char_A  | 「古いメモが落ちている。『Bの家に行け』と書かれている。」 | `expands:31`                       |
| 31 | 101       | char_B  | 「何の用だ？」                           | `dialogue`                         |
| 32 | 102       | char_B  | 「…そうか、あのメモを読んだのだな。…」 | `requires:30`                      |
| 33 | 103       | char_B  | 「(メモの事を話していないな。…)」       | `interpretation_for:31`            |
| 34 | 200       | system  | どの情報を信じる？                       | `CHOICE:35,36`                     |
| 35 | 201       | player  | Aの言うことを信じる                     | `choice_option`                    |
| 36 | 202       | player  | Bの言うことを信じる                     | `choice_option`                    |

### 予約済みコマンド

`reason`フィールドに記述するコマンドは、`コマンド名:引数1,引数2,...`という形式を取る。

#### `requires:<id>`

-   **機能**: この命題が提示されるための**前提条件**を定義する。
-   **詳細**: `id`で指定された命題をプレイヤーが既に知っている（`_knownPropositionIds`に含まれている）場合にのみ、この命題は提示対象となる。
-   **例**: `requires:30`は、ID:30の情報を知っていることが条件となる。

#### `expands:<id>`

-   **機能**: 物語を**動的に拡張**する。
-   **詳細**: このコマンドを持つ命題が提示されると、`id`で指定された命題が割り込みキュー（`_narrativeQueue`）に追加される。これにより、タイムラインの順序とは関係なく、関連するイベントを発生させることができる。
-   **例**: `expands:31`は、この命題が表示された直後にID:31をキューに入れる。

#### `interpretation_for:<id>`

-   **機能**: 特定の情報に対するキャラクターの**思考や解釈**を表現する。
-   **詳細**: `LogicEngine`は初期化時にこのコマンドを検出し、トリガーとなる`id`と、この解釈命題を紐付けておく。トリガー`id`の命題が提示された瞬間に、この解釈命題が割り込みキューに追加される。
-   **例**: `interpretation_for:31`は、ID:31が提示されたキャラクターの心の声などを表現するのに使う。

#### `CHOICE:<id1>,<id2>,...`

-   **機能**: プレイヤーに**選択肢**を提示する。
-   **詳細**: `GameManager` (UI層) がこのコマンドを検出し、指定された各`id`を持つ命題を元に選択肢ボタンを生成する。プレイヤーが選択を行うと、選ばれた`id`が`LogicEngine`に渡され、物語が分岐する。
-   **例**: `CHOICE:35,36`は、ID:35とID:36の内容をプレイヤーの選択肢として提示する。

---
*2024年7月29日更新*