# Architecture Refactor Plan (アーキテクチャ刷新計画)

## 1. 背景と目的

プロジェクトの初期段階で提示された仕様案（`NarrativeGen_ 論理エンジンとナラティブ生成システムの仕様案.md`）に基づき、システムのアーキテクチャをより堅牢で拡張性の高いものへと刷新する。

現在の「Proposition（命題）」を中心とした単一のデータ構造は、プロトタイプとしては有効だったが、以下の点で将来的な拡張性に課題がある。

-   「発言」や「事件」といった抽象的な概念を、それ自体が評価の対象となる「モノ」として扱いにくい。
-   「誰が、なぜ、何を知っているのか」という情報の来歴を追跡する構造が複雑化しやすい。

本計画の目的は、**シンプルさと拡張性**を両立させた新しいアーキテクチャへ移行することにある。コンポーネントの責務を明確に分離することで、将来的な機能追加（「曖昧さ」の導入など）を容易にすることを目指す。

---

## 2. 新アーキテクチャの概要：Entity-Relationモデル

新しいアーキテクチャは、2つのCSVファイルを中心とした**「エンティティ-関係性（Entity-Relation）」モデル**を採用する。

-   **`Entities.csv`（世界の登録簿）**
    -   **役割:** 物語に登場する、あるいは言及される全ての「モノ」を一意なIDで登録する。
    -   **内容:** キャラクター、場所、アイテムだけでなく、「Cの失踪事件」といったトピックや、「Bの目撃証言」といった発言内容そのものもエンティティとして扱う。
    -   **責務:** 「何が存在するか」を定義する。

-   **`Relations.csv`（関係性のログ）**
    -   **役割:** エンティティ間で発生した全ての出来事、行動、思考、評価を時系列で記録する。
    -   **内容:** `[主語]が [目的語] に [動詞] する` というSVO形式を基本とする。（例: `[char_A] [tells] [char_B] about [S001]`）
    -   **責務:** 「何が起きたか」を記録する。

### コンポーネントの責務分離

このモデルに基づき、主要なスクリプトの役割を以下のように明確に分離する。

1.  **`DatabaseManager.cs`**: `Entities.csv`と`Relations.csv`を読み込み、データモデルに変換する**だけ**のローダー。
2.  **`LogicEngine.cs`**: `Relations.csv`のログを解釈し、各キャラクターの知識ベース（何を知っているか、どう評価しているか）を構築・更新する**思考エンジン**。
3.  **`NarrativeGenerator.cs`**: `LogicEngine`から特定の`Relation`レコードやキャラクターの状態を受け取り、それを自然な日本語のテキストに変換する**文章生成器**。

この分離により、例えば「新しい言い回しを追加したい」場合は`NarrativeGenerator.cs`を修正するだけでよく、物語の論理（`LogicEngine.cs`）には一切影響を与えない。この構造こそが、シンプルさと拡張性を両立させる鍵となる。

---

## 3. 段階的な移行計画

以下の3フェーズで、段階的にアーキテクチャを移行する。

### Phase 1: データ構造の刷新 (Data Model Refactoring)

**ゴール:** 新しいデータ構造（`Entities.csv`, `Relations.csv`）を読み込める状態にする。

1.  **データモデル定義:** `DataModels.cs`を改修し、仕様案に沿った`EntityRecord`と`RelationRecord`のC#クラスを定義する。
2.  **サンプルCSV作成:** `Assets/StreamingAssets/NarrativeData/`に、新しい形式の`Entities.csv`と`Relations.csv`を作成する。
3.  **ローダー改修:** `DatabaseManager.cs`を改修し、新しい2つのCSVファイルを読み込むように変更する。

### Phase 2: ロジックエンジンの改修 (Logic Engine Refactoring)

**ゴール:** `Relations.csv`のログに基づき、キャラクターの知識を正しく構築できるようにする。

1.  **知識構築ロジック実装:** `LogicEngine.cs`の知識構築ロジックを刷新する。「BがAにS001をtellsした」という`Relation`を読み、「Aの知識にS001を追加する」処理を実装する。
2.  **デバッグ表示の更新:** `DebugDisplay`が、新しい知識構造を正しく表示できるように改修する。

### Phase 3: ナラティブ生成エンジンの分離 (Narrative Generator Separation)

**ゴール:** ロジックと表現（テキスト生成）を完全に分離する。

1.  **`NarrativeGenerator.cs`の作成:** 新しく`NarrativeGenerator.cs`を作成する。
2.  **ロジックの移管:** `GameManager`などに混在しているテキスト表示ロジックを、`NarrativeGenerator.cs`に移管する。
3.  **`GameManager`の役割変更:** `GameManager`は、UIイベントを受け取り、`LogicEngine`と`NarrativeGenerator`を協調させる司令塔としての役割に専念する。

この計画に沿って開発を進めることで、システムの基盤をより強固なものへと進化させることができる。 