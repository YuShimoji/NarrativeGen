# Entity-Property システム実装ロードマップ

## 実装方針: 新規作成による段階的構築

### 決定根拠
- 現在の技術的負債が深刻（アーキテクチャ不整合、Unity依存混在）
- memo.txt による設計思想の根本的転換（イベント駆動 → Entity中心）
- 既存修復よりも新規作成の方が効率的かつ確実

---

## Phase 1: 基盤システム構築 (1-2セッション)

### 1.1 プロジェクト構造整理
**目標**: クリーンな開発環境の確立

**タスク**:
- [ ] 既存問題コードのバックアップ移動
- [ ] 新しいフォルダ構造の作成
- [ ] .NET Core テストプロジェクトの再構築

**成果物**:
```
Assets/Scripts/
├── Core/                 # Entity-Property システム
│   ├── Entities/
│   ├── Properties/
│   └── Managers/
├── Generation/           # テキスト生成システム
│   ├── Syntax/
│   └── Reasoning/
├── Unity/               # Unity統合層
│   └── Controllers/
└── Tests/               # 単体テスト
```

### 1.2 Entity基盤クラス実装
**目標**: Entity-Property システムの核心実装

**実装順序**:
1. `PropertyValue` 構造体
2. `Entity` クラス
3. `EntityType` クラス  
4. `EntityManager` クラス

**検証基準**:
- Entity作成・取得・削除の基本操作
- プロパティ設定・継承の動作確認
- 階層的継承ロジックの正常動作

### 1.3 CSV読込み基盤
**目標**: データ駆動型システムの基礎確立

**実装内容**:
- Entity定義CSV読込み
- EntityType定義CSV読込み
- プロパティ継承関係の構築

**テストケース**:
- memo.txt例（マックのチーズバーガー）の完全再現
- 階層的継承の検証
- データ整合性チェック

---

## Phase 2: テキスト生成システム (2-3セッション)

### 2.1 構文解析エンジン
**目標**: `{scene description:[あなたは[LOCATION]に立っている。]}` 形式の解析

**実装内容**:
- `SyntaxPattern` クラス
- `SyntaxEngine` クラス
- 入れ子構造パーサー
- Entity参照展開機能

**検証基準**:
- memo.txt記載例の完全解析
- 複雑な入れ子構造の処理
- エラーハンドリングの確実性

### 2.2 言い換えシステム
**目標**: 使用履歴を考慮した動的表現選択

**実装内容**:
- 言い換え辞書管理
- 使用履歴記録
- 重複回避アルゴリズム

**検証基準**:
- 同一表現の連続使用回避
- 文脈に応じた適切な選択
- 表現バリエーションの豊富さ

### 2.3 Unity統合層
**目標**: Entity システムとUnity UIの連携

**実装内容**:
- `NarrativeController` クラス
- UI更新イベント機構
- デバッグ表示機能

---

## Phase 3: 推論システム (3-4セッション)

### 3.1 基本推論エンジン
**目標**: プロパティ比較による違和感検出

**実装内容**:
- `ReasoningEngine` クラス
- `ReasoningRule` システム
- 不整合検出アルゴリズム

**検証基準**:
- キャラクター知識との照合
- 矛盾する情報の検出
- 適切な閾値設定

### 3.2 動的Entity生成
**目標**: 事象Entityの自動生成

**実装内容**:
- 文脈分析ロジック
- 事象Entity生成ルール
- 動的ストーリー展開

### 3.3 高度な構文機能
**目標**: 条件付き生成・複雑な入れ子構造

**実装内容**:
- 条件分岐構文
- ループ構文
- 動的選択ロジック

---

## 各Phase完了基準

### Phase 1 完了基準
- [ ] Entity基本操作の完全動作
- [ ] 階層的プロパティ継承の実装
- [ ] CSV読込み・Entity生成の自動化
- [ ] 単体テストカバレッジ80%以上

### Phase 2 完了基準  
- [ ] memo.txt記載例の完全再現
- [ ] 基本的な構文解析・テキスト生成
- [ ] Unity UIとの正常連携
- [ ] 言い換えシステムの動作確認

### Phase 3 完了基準
- [ ] 推論エンジンによる違和感検出
- [ ] 事象Entity自動生成の実現
- [ ] 動的で豊かな表現生成
- [ ] 包括的な統合テスト完了

---

## リスク管理

### 主要リスク
1. **複雑性の爆発**: 推論ロジックの過度な複雑化
2. **パフォーマンス問題**: 大量Entity処理の性能不足
3. **データ設計ミス**: CSV構造の根本的欠陥

### 軽減策
1. **最小実装原則**: 段階的機能追加
2. **プロトタイプ重視**: 早期検証・修正
3. **ベンチマーク設定**: 性能目標の明確化

---

## 開発環境・ツール

### 必須ツール
- Unity 2022.3 LTS
- .NET 8.0 SDK
- NUnit テストフレームワーク
- CSV処理ライブラリ

### 推奨ツール
- PlantUML (アーキテクチャ図)
- Benchmark.NET (性能測定)
- Git LFS (大容量CSVファイル管理)

---

## 成功指標

### 技術的指標
- コードカバレッジ: 80%以上
- 単体テスト実行時間: 10秒以内
- Entity生成速度: 1000個/秒以上

### 機能的指標
- memo.txt全例の完全再現
- 表現バリエーション: 同一内容で10通り以上
- 違和感検出精度: 90%以上

### 保守性指標
- 新機能追加時間: 既存機能の20%以内
- バグ修正時間: 平均1時間以内
- ドキュメント更新率: 100%
