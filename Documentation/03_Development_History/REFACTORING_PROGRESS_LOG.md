# V3アーキテクチャへのリファクタリング進捗ログ

## 1. 全体目標
ナラティブ生成システムを、柔軟性・拡張性・データ駆動性を重視した「V3アーキテクチャ」へ全面的に刷新する。

## 2. 完了した主要タスク

### 2.1. アーキテクチャの刷新
- **MonoBehaviourからの分離:** `LogicEngine`, `DatabaseManager`といった主要なロジックをUnityのシーンオブジェクト(`MonoBehaviour`)への強い依存から切り離し、純粋なC#クラスとして再設計しました。
- **WorldStateの導入:** ゲーム世界のあらゆるオブジェクト（エンティティ）の状態を一元的に管理する`WorldState`クラスを導入しました。これにより、状態の追跡と変更が容易になりました。
- **データ駆動モデル:** 物語の登場人物やアイテムは、すべて`Entities.csv`で定義される動的なプロパティを持つ`Entity`として扱われるようになりました。

### 2.2. 堅牢なCSVパーサーへの置換
- **最重要改善点:** 当初、システムの多くの不安定さの原因となっていた正規表現ベースのCSVパーサーを完全に破棄しました。
- **手動解析パーサーの実装:** 引用符やカンマを含む複雑なコマンド文字列を正確に解析できるよう、1文字ずつ状態を管理する、より信頼性の高い手動解析方式の`CsvParser`に書き換えました。これにより、システムの安定性が大幅に向上し、今後の開発の堅牢な土台が完成しました。

### 2.3. 基本コマンドの実装
`LogicEngine`に、以下の基本的な物語制御コマンドのロジックを実装しました。

- `SAY(character, text)`: テキストを表示します。
- `GOTO(eventId)`: 指定したイベントへ遷移します。
- `SET(entity.property, value)`: `WorldState`内のエンティティの状態を変更します。
- `IF(condition, eventIdIfTrue, eventIdIfFalse)`: 条件を評価し、結果に基づいてイベントを分岐させます。

## 3. 現在の状況と課題

### 3.1. 現在のフェーズ
- 短期開発計画「①状態変更(`SET`)」「②条件分岐(`IF`)」「③プレイヤー選択肢(`CHOICE`)」のうち、**「②条件分岐(`IF`)」の実装を完了し、そのテストを行っている段階**です。

### 3.2. 直面している技術的課題
- **Unityシーン操作の不安定性:** `IF`コマンドのテストを実行する過程で、MCPツール（`manage_gameobject`など）によるUnityシーン内のオブジェクト操作（検索、作成、コンポーネントの関連付け）が、予期せず失敗するという問題が継続的に発生しています。
- **影響:** この問題により、テストに必要な`GameManager`と`UIManager`の接続が妨げられ、進捗が一時的に停滞しています。シーンの状態を正確に把握できず、誤った判断（UIが存在しないと誤認するなど）を招く原因ともなっています。

## 4. 今後の計画

1.  **シーン操作問題の回避:** 不安定なシーン検索に依存せず、既存のUIコンポーネントと`GameManager`を直接接続するアプローチを試みます。
2.  **`IF`コマンドのテスト完了:** 上記の問題を解決し、`player.is_brave`のシナリオを正常に動作させ、`IF`コマンドの機能性を完全に検証します。
3.  **`CHOICE`コマンドの実装:** 短期計画の最終ステップとして、プレイヤーに選択肢を提示し、その結果によって物語を分岐させる`CHOICE`コマンドの実装に着手します。

---

## 5. 変更履歴（2025-08-21）

- ドキュメント整備の強化を実施。
  - `Documentation/01_Current_Status/TASK_LIST.md` を新規作成。
    - タスクID対応表（TODOリスト連携）、受け入れ基準、担当、見積、期日を各タスクに追加。
  - `README.md` にタスクリストへのリンクを追記。
  - `Documentation/01_Current_Status/CURRENT_PROJECT_STATUS.md` に直近更新の追記と「テスト手順サマリ（データロードと開始イベント）」を追加。
 - 目的: CSVロード安定化と開始イベント実行の検証を確実化し、開発タスクの可視性を向上。

## 6. 変更履歴（2025-08-22）

- 起動時エラーハンドリング/リトライ機構の導入。
  - `UIManager.ShowError()` とリトライボタン生成 (`SetupRetryButton()`) を実装・整理。
  - `GameManager.ProcessNarrativeResult()` に `Error` 処理と `OnRetryRequested` 購読・再初期化 (`HandleRetryRequested`) を追加。
  - `LogicEngine` 側の `NarrativeResult.ResultType.Error` 返却ポリシー強化の受け口を用意。
- ドキュメント整備。
  - `CURRENT_PROJECT_STATUS.md` にエラー表示/リトライのテスト手順と既知の注意点を追記。
  - `TASK_LIST.md` で A-3/C-2 を進行中に、C-0（Unity参照/IDEアナライザ不整合の整理）を追加。
  - `README.md` に要約テスト手順と IDE 注意を追記。
- IDE 偽陽性対策。
  - `.csproj`（Core）で `Assets/**` とバックアップをビルド対象から除外し、Unity 参照の未解決エラーを .NET 側から分離。