# NarrativeGen プロジェクト現状報告 V4

**更新日: 2024年1月15日**  
**バージョン: 4.0**  
**基準ドキュメント: memo.txt + 01_CORE_DESIGN_PHILOSOPHY.md**

---

## 0. 重要な方針転換

### 0.1 memo.txtによる設計思想の刷新

memo.txtに記載された本質的な方針により、従来のアーキテクチャから **「Entity中心のプロパティ駆動型ナラティブ生成」** への全面的な方針転換を実施しました。これまでのドキュメントや実装はこの新しい方針を反映していないため、全面的な再設計・再実装が必要です。

### 0.2 核心的変更点

- **従来**: イベント駆動・プロポジション駆動アプローチ
- **新方針**: Entity-Property システム + 構文ベース生成
- **従来**: ロジックと修辞の分離
- **新方針**: 統合的なEntity管理による一貫性確保
- **従来**: 静的なテンプレート生成
- **新方針**: 階層的継承と動的推論による生成

---

## 1. 現在のシステム状況

### 1.1 アーキテクチャ状況

**既存実装の問題点**:
- 自己参照・循環呼び出しによる無限ループ
- コンポーネント間の責務不明確
- namespace重複による実装困難
- 新方針未対応の設計思想

**現在の実装可能性**: ❌ **不可**
- 大量のコンパイルエラー
- 基本的な設計思想の相違
- CsvHelper等の依存関係不明確

### 1.2 技術的負債の蓄積

現在のコードベースは以下の理由により使用不可：
1. **アーキテクチャ不整合**: memo.txt方針と完全に異なる設計
2. **実装の不完全性**: 半完成状態のファイル群
3. **依存関係の混乱**: 未定義クラス・namespace問題
4. **思想的矛盾**: 複数の異なるアプローチの混在

---

## 2. 新しい設計方針の確立

### 2.1 Entity-Property システム

**目標アーキテクチャ**:
```
EntityManager (中核)
├── Entity生成・管理・破棄
├── プロパティ階層的継承
├── 描写履歴・使用履歴記録
└── Entity間関係管理
```

**実装優先度**:
1. **Phase 1**: 基本Entity-Property システム
2. **Phase 2**: 構文解析・生成エンジン
3. **Phase 3**: 推論エンジン・違和感検出

### 2.2 構文ベース生成システム

**メモ基準の構文**:
```
{scene description:[あなたは[LOCATION]に立っている。], {目の前には[OBJECT]がある。}}
```

**技術要件**:
- 入れ子構造の解析・処理
- Entity/プロパティ動的参照
- 条件付き生成ロジック
- 言い換え辞書システム

### 2.3 推論エンジン

**memo.txt記載の核心機能**:
- プロパティ比較による違和感検出
- キャラクター知識との照合
- 事象Entityの自動生成
- 動的ストーリー展開

---

## 3. CSV データ構造設計

### 3.1 必要なCSVファイル構成

```
NarrativeData/
├── Entities.csv          # Entity定義・プロパティ
├── SyntaxPatterns.csv    # 構文パターン・テンプレート
├── Paraphrases.csv       # 言い換え辞書
├── Descriptions.csv      # Entity描写要素
├── CharacterKnowledge.csv # キャラクター知識定義
├── ReasoningRules.csv    # 推論ルール・閾値
└── EventTemplates.csv    # 事象Entity生成ルール
```

### 3.2 データ構造設計原則

**階層的プロパティ継承**:
```
既定値 → コモン → 具体的インスタンス
```

**例**: マックのチーズバーガー
```
携帯食料(weight:0.1) → マックのチーズバーガー(size:0.3) → 誰々が食べていた〜(weight:0.12)
```

---

## 4. 実装計画

### 4.1 短期計画 (次回1-2セッション)

**最優先タスク**:
1. **現在コードの全面的なクリーンアップ**
   - コンパイルエラーの全解決
   - 不要ファイルの削除
   - 新方針に沿わないコードの除去

2. **基本EntityManager実装**
   - Entity基本クラス設計
   - PropertyValue構造体設計
   - 階層的継承ロジック実装

3. **CSV読込み基盤の確立**
   - CsvHelper依存関係の解決
   - 基本的なEntity読込み機能

### 4.2 中期計画 (3-5セッション)

**Phase 1完了目標**:
1. **構文解析エンジン基礎**
   - 基本的な`{}`、`[]`パース機能
   - Entity参照展開機能
   - 単純なテキスト生成

2. **言い換え辞書システム**
   - プロパティ条件による選択
   - 使用履歴記録
   - 重複回避機能

3. **UI統合**
   - EntityManager ↔ UIManager連携
   - 動的テキスト表示
   - デバッグ表示機能

### 4.3 長期計画 (6-10セッション)

**Phase 2-3完了目標**:
1. **推論エンジン実装**
   - プロパティ比較ロジック
   - 違和感検出アルゴリズム
   - 事象Entity自動生成

2. **高度な構文機能**
   - 複雑な入れ子構造
   - 条件付き生成
   - 動的選択ロジック

3. **包括的テスト・調整**
   - 各種パターンでの生成テスト
   - パフォーマンス最適化
   - 表現品質の向上

---

## 5. 技術的課題と対策

### 5.1 主要な技術的課題

1. **パフォーマンス**: 大量Entity・複雑な継承関係の処理
2. **メモリ管理**: 動的Entity生成・履歴データ蓄積
3. **デバッグ難易度**: 複雑な推論ロジックの追跡

### 5.2 対策方針

1. **段階的実装**: 最小機能から順次拡張
2. **キャッシング戦略**: 頻繁にアクセスされるデータの最適化
3. **ログ・デバッグ機能**: 推論過程の可視化

---

## 6. 品質管理・検証方針

### 6.1 継続的検証

- **各Phase完了時**: 機能動作確認
- **CSV更新時**: データ整合性チェック
- **生成テスト**: 表現品質・バリエーション確認

### 6.2 ドキュメント連携

- **設計変更時**: ドキュメント即座更新
- **実装進捗**: 開発記録への詳細記載
- **課題発見時**: 技術仕様書への反映

---

## 7. 成功指標

### 7.1 Phase 1成功指標

- [ ] Entity基本操作（作成・参照・更新）の動作確認
- [ ] 階層的プロパティ継承の正常動作
- [ ] CSV読込み・Entity生成の完全自動化
- [ ] 基本的な構文解析・テキスト生成

### 7.2 Phase 2-3成功指標

- [ ] memo.txt記載例の完全再現
- [ ] 推論エンジンによる違和感検出動作
- [ ] 事象Entity自動生成・参照
- [ ] 動的で豊かな表現生成の実現

---

## 8. リスク要因と対策

### 8.1 主要リスク

1. **複雑性の爆発**: 推論ロジックの過度な複雑化
2. **データ設計ミス**: CSV構造の根本的欠陥
3. **パフォーマンス問題**: 実用レベルでの性能不足

### 8.2 リスク軽減策

1. **最小実装原則**: 段階的機能追加
2. **プロトタイプ重視**: 早期検証・修正
3. **ベンチマーク設定**: 性能目標の明確化

---

**結論**: 現在のプロジェクトは、memo.txtの方針に基づく全面的な再設計・再実装フェーズにあります。既存実装の技術的負債を解消し、新しい設計思想に基づく実装を段階的に進めることで、革新的なナラティブ生成システムの実現を目指します。 