# NarrativeGen プロジェクト状況 V5.0

**更新日: 2024年**  
**基準ドキュメント: 構文メモ.txt + SYNTAX_ENGINE_SPECIFICATION.md**

---

## 🎯 プロジェクト現状サマリー

### 設計完了度
- ✅ **構文エンジン設計**: 100% (SYNTAX_ENGINE_SPECIFICATION.md)
- ✅ **Entity-Property システム設計**: 95% (memo.txt 基準)
- ✅ **CSV構造設計**: 90% (詳細仕様確定済み)
- ❌ **実装進捗**: 0% (完全な再設計により既存コードは使用不可)

### 技術的負債状況
- 🔴 **既存コード**: 完全廃棄対象（設計思想の根本的相違）
- 🔴 **コンパイルエラー**: 解決優先度低（新規実装のため）
- 🟢 **設計基盤**: 堅牢（構文メモ.txt 完全準拠）

---

## 📋 実装予定システム詳細

### Phase 1: 構文エンジン基盤 (4-6週間)

#### 1.1 Core Infrastructure
```
SyntaxEngine (MonoBehaviour)
├── CSVDataLoader - 全CSVファイル読み込み・キャッシング
├── RecursiveResolver - 遡行検索エンジン ([～] → 辞書検索 → 再帰)
├── CommandProcessor - テキスト内コマンド処理 (r, ||, &&, if等)
├── VariableManager - 変数・条件システム
└── ErrorHandler - 循環参照・深度制限・フォールバック
```

#### 1.2 必要なCSVファイル (新規4 + 拡張2)

**新規作成**:
1. `RecursiveDictionary.csv` - 遡行検索辞書
2. `SyntaxCommands.csv` - コマンド処理定義  
3. `Variables.csv` - 変数定義・管理
4. `TranslationUnits.csv` - 文単位制約

**拡張**:
1. `SyntaxPatterns.csv` - コマンド・変数フィールド追加
2. `Paraphrases.csv` - 再帰用語・翻訳グループ追加

#### 1.3 実装アルゴリズム核心部分

**遡行検索アルゴリズム**:
```csharp
// 構文メモ.txt の核心: 「[～]が残っていれば更に遡って検索」
string ProcessRecursive(string input) 
{
    while (ContainsBrackets(input)) {
        string term = ExtractFirstBracket(input);
        string resolved = DictionaryLookup(term);
        input = input.Replace($"[{term}]", resolved);
        
        // 循環参照・深度チェック
        if (DetectCircularReference() || ExceedsMaxDepth()) {
            return Fallback(input);
        }
    }
    return input;
}
```

**テキスト内コマンド処理順序**:
```
1. if/else 条件分岐処理
2. {A||B||C} 選択肢処理  
3. [A]&&[B] 連動選択処理
4. r[A][B]r ランダム挿入処理
5. [～] 遡行検索処理
```

### Phase 2: Entity-Property統合 (2-3週間)

#### 2.1 Entity システム統合
```csharp
EntityManager
├── PropertyInheritance - default → common → specific 継承
├── ReasoningEngine - プロパティ比較・違和感検出  
├── EventEntityGenerator - 体験をEntityとして動的生成
└── CharacterKnowledgeSystem - キャラクター固有の認識精度
```

#### 2.2 推論エンジン実装
**memo.txt チーズバーガー例の完全実装**:
```
探偵A: チーズバーガー重量 0.12kg を観測
期待値: 0.1kg ±10% (0.09-0.11kg)
判定: 0.12kg > 0.11kg → 違和感検出
生成テキスト: [微妙に重い気がする。本当にチーズバーガーだったのか？]
```

### Phase 3: 高度機能・最適化 (2-3週間)

#### 3.1 ライティング支援システム
- 逆引き検索 (どの辞書項目が特定の語を含むか)
- 未使用項目検出
- 循環参照事前チェック
- パフォーマンス影響可視化

#### 3.2 翻訳対応システム
- 文単位制約の厳格な実装
- 言語別処理パイプライン
- 翻訳品質チェック

---

## 🚀 開発計画・マイルストーン

### 短期計画 (次の2-3回の作業セッション)

#### セッション1: CSV基盤構築
- [ ] 新規4CSVファイルの作成・サンプルデータ投入
- [ ] CSVDataLoader クラス実装
- [ ] 基本的なデータ構造定義

#### セッション2: 遡行検索エンジン
- [ ] RecursiveResolver クラス実装
- [ ] 単純な[～]パターン処理
- [ ] 循環参照・深度制限システム

#### セッション3: コマンド処理基盤  
- [ ] ランダム挿入(r)コマンド実装
- [ ] 選択肢(||)コマンド実装
- [ ] 基本的なテスト環境構築

### 中期計画 (次の5-7回の作業セッション)

#### 完全なコマンドシステム実装
- [ ] 条件分岐 (if/else) システム
- [ ] 連動選択 (&&) コマンド
- [ ] 変数システム統合
- [ ] エラーハンドリング強化

#### Entity-Property システム統合
- [ ] 推論エンジン実装
- [ ] 動的事象Entity生成
- [ ] キャラクター知識システム

### 長期計画 (次の10-15回の作業セッション)

#### 高度機能・最適化
- [ ] パフォーマンス最適化
- [ ] ライティング支援ツール
- [ ] 翻訳対応システム
- [ ] エディタ拡張開発

---

## ⚡ 技術要件・制約

### 性能要件
```
基本遡行検索: < 10ms
複雑コマンド処理: < 50ms  
辞書キャッシュヒット率: > 95%
メモリ使用量: < 100MB
```

### 品質要件
```
循環参照検出率: 100%
無限ループ防止: 100%
グレースフルデグラデーション: 100%
データ整合性チェック: 100%
```

### 開発制約
- **文のかたまり単位原則**: 翻訳対応のため厳格に遵守
- **思いつき回避**: 当て推量でのバリエーション増加禁止
- **YAGNI/KISS/DRY**: 簡潔性・機能分離の徹底
- **エラーログ制御**: Unity Console への出力量制御

---

## 🔧 実装準備状況

### 完了済み
- ✅ 完全な技術仕様書 (SYNTAX_ENGINE_SPECIFICATION.md)
- ✅ 設計思想の明確化 (構文メモ.txt 準拠)
- ✅ CSVファイル構造設計
- ✅ アルゴリズム詳細設計
- ✅ 実装優先順位確定

### 実装開始準備完了項目
- ✅ 核心アルゴリズム設計
- ✅ クラス構造設計
- ✅ エラーハンドリング戦略
- ✅ テスト戦略
- ✅ パフォーマンス目標

### 次の作業で即座に着手可能
1. **CSVファイル作成** (新規4ファイル)
2. **基盤クラス実装** (SyntaxEngine, RecursiveResolver)
3. **単体テスト環境構築**

---

## 📊 リスク分析・対策

### 高リスク項目
1. **遡行検索の複雑性**: 十分なテスト・デバッグ機能で対応
2. **パフォーマンス**: キャッシング・最適化で対応
3. **CSV管理複雑性**: エディタ拡張・バリデーションで対応

### 中リスク項目
1. **デバッグ困難性**: 可視化ツール・ログシステムで対応
2. **翻訳対応複雑性**: 段階的実装で対応

### 対策済み項目
- ✅ 設計思想の明確化
- ✅ 技術的実現性の確認
- ✅ 実装段階の詳細化

---

## 🎯 今後の展開

この設計基盤により、memo.txtと構文メモ.txtの要求を完全に満たしたナラティブ生成システムの実装が可能になりました。

**次の具体的作業**: 
1. CSVファイル構造の最終確認・作成
2. SyntaxEngine基盤クラスの実装開始
3. 遡行検索アルゴリズムの実装・テスト

**実装完了時の達成項目**:
- Entity-Property駆動の動的ナラティブ生成
- 完全な遡行検索による豊富な表現バリエーション  
- 推論エンジンによる自然な違和感検出・反応
- 多言語対応の翻訳システム基盤 