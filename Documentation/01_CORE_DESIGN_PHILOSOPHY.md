# NarrativeGen - 核心的設計思想

**バージョン: 4.0**  
**基準ドキュメント: memo.txt**

---

## 0. 設計思想の根幹

本システムは「**Entity中心のプロパティ駆動型ナラティブ生成**」を核心思想とする。全ての要素がEntityとしてプロパティを持ち、階層的継承と構文ベース生成により、動的で一貫性のある物語を創造する。

---

## 1. Entity-Property システム

### 1.1 基本概念

**Entity**: ゲーム世界の全ての要素（人物、物体、事象、概念等）
**Property**: Entityが持つ属性値
- 既定値（デフォルト）
- 設定値（個別指定）
- 範囲（2~4、±3%等）
- ラベル・メタ情報

### 1.2 階層的プロパティ継承

```
既定値 → コモン → 具体的インスタンス
例: 「携帯食料」→「マックのチーズバーガー」→「誰々が食べていたマックのチーズバーガー」
```

**継承の流れ**:
1. 「携帯食料」の既定値: 重さ0.1、大きさ0.1
2. 「コモン：マックのチーズバーガー」: 重さ0.1、大きさ0.3で上書き
3. 「誰々が食べていた〜」: 重さ0.12で個別指定

### 1.3 プロパティの種類

- **物理属性**: 重さ、大きさ、色、材質
- **状態属性**: 開いている/閉じている、新しい/古い
- **関係属性**: 所有者、場所、関連Entity
- **メタ属性**: 記述回数、最終参照時刻、描写済み要素

---

## 2. 入れ子構造によるストーリー生成

### 2.1 階層構造

```
ストーリー {
  章1 {
    節1 {
      段落1,
      段落4～6から2つ,
      段落2,
      段落42
    }
    節2 { ... }
  }
  章2 { ... }
}
```

### 2.2 各階層の責務

- **章**: 大きな物語の区切り
- **節**: テーマや場面の区切り
- **段落**: 一連の文章群
- **文章**: 意味的なまとまり
- **文**: 構文単位
- **単語**: 最小構成要素

### 2.3 選択と置き換え

全ての要素は置き換え可能性・追加可能性を持つ：
- 条件付き選択（プロパティによる）
- ランダム選択（同一評価の要素間）
- 使用履歴による重複回避

---

## 3. 構文ベース生成エンジン

### 3.1 構文記述法

```
{scene description:[あなたは[LOCATION]に立っている。], {目の前には[OBJECT]がある。}, {[sound] が [direction]から聞こえる。}}
```

### 3.2 構文要素

- **`{}`**: セクション区切り
- **`[]`**: Entity/プロパティ参照
- **`{}`内のカンマ**: 文章の区切り
- **プロパティ指定**: `[文章[プロパティ：現代の建物の中の情景描写]]`

### 3.3 条件付き生成

```
[心理描写21～24のうちどれか2つ][心理描写22～23のうち使われていない文（両方とも使われていた場合22）]
```

---

## 4. 言い換え辞書システム

### 4.1 基本概念

同一の意味を持つ複数の表現を辞書として管理：

```
「窓が開いているな」と気づいた。
↓ 言い換え辞書
- （どうやら窓が開いているようだ）
- 窓が開いているのが見えた。
- ふと見ると、窓が開いていることに気づいた。
```

### 4.2 選択条件

- **プロパティマッチング**: 人称、文体、口調、文字数等
- **使用履歴**: 重複回避のための使用回数記録
- **文脈適合性**: 前後の文章との整合性

### 4.3 Entity描写の蓄積

```
[窓] → 「漆喰塗の白い壁にある、割れた、古びた、木製の、木枠の、透明な、薄汚れた、暫くの間誰も手を付けていない」
```

描写された要素は別辞書に記録され、ストーリー内での齟齬回避と表現の豊かさに寄与。

---

## 5. 推論エンジン

### 5.1 プロパティ比較による違和感検出

**例**: 【都会の現代人】の認識と実際のEntityプロパティ比較
- 期待値: 重さ0.1 ±10%（0.09-0.11）
- 実際値: 重さ0.12
- 結果: 範囲外のため違和感発生

### 5.2 事象Entityの生成

違和感や体験は新しいEntityとして記録：
```
事象Entity: 「責められたこと」
- 辛辣さ: 75
- 妥当性: 99
- タイムスタンプ: [記録時刻]
- 関連人物: [A, B]
```

### 5.3 動的ストーリー展開

記録された事象Entityは適切なタイミングで参照され、新たな会話や展開を生成：
- 共通話題の発見
- 過去の経験との関連付け
- キャラクター関係の発展

---

## 6. データ構造設計指針

### 6.1 CSV構造の基本方針

- **Entity定義CSV**: ID、型、プロパティ定義
- **構文ルールCSV**: パターン、条件、テンプレート
- **言い換え辞書CSV**: グループID、バリエーション、プロパティ
- **推論ルールCSV**: 条件、アクション、閾値

### 6.2 プロパティ記述法

```csv
entity_id,property_name,default_value,current_value,range_min,range_max,range_type,labels
window_01,material,glass,glass,,,,"古い,汚れた,透明"
player_01,knowledge_modern_food,0.8,0.8,0.7,0.9,percentage,"都会の現代人"
```

### 6.3 拡張性の確保

- 新しいプロパティタイプの追加
- 推論ルールの動的追加
- 言語別辞書の分離管理

---

## 7. 実装優先順位

### Phase 1: 基盤システム
1. Entity-Property システム
2. 基本的な構文解析エンジン
3. 単純な言い換え辞書

### Phase 2: 推論機能
1. プロパティ比較エンジン
2. 事象Entity生成
3. 基本的な違和感検出

### Phase 3: 高度な機能
1. 複雑な入れ子構造生成
2. 動的ストーリー展開
3. 学習機能（使用履歴の活用）

---

この設計思想に基づき、全てのコンポーネントが Entity-Property システムを中心として統合され、動的で豊かな物語生成を実現する。 