### プロジェクト仕様・開発計画書：NarrativeGen

#### 1. プロジェクト概要

*   **プロジェクト名:** NarrativeGen
*   **コンセプト:** 構文ベースの動的生成システムによる、無限に生成される物語体験。
*   **目標:**
    *   論理的に破綻しない、無数のストーリーバリエーションの自動生成。
    *   ミステリーなど、厳密な論理整合性が求められるジャンルへの対応。
    *   効率的な多言語展開が可能なシステム設計。
*   **ターゲットプラットフォーム:** PC / Mobile (Unity)

#### 2. コアシステム設計

##### 2.1. 動的ストーリー生成エンジン

3つの主要モジュールで構成されます。

1.  **構文解析モジュール:** シナリオテキストを解析し、変数、配列、論理トリガーを識別します。
2.  **論理整合性モジュール:** データベースから情報を参照し、物語の矛盾（時空間、証言の矛盾など）を検出し、回避します。
3.  **ナラティブ生成モジュール:** 構文と論理に基づき、テキスト要素を再構成し、最終的な物語の文章を生成します。

##### 2.2. データ構造：命題ユニット

すべての情報は「命題ユニット」として原子的に管理されます。これは、ご提示いただいた複数のアイデアを統合したものです。

*   **基本構造:**
    *   `ID`: 一意の識別子
    *   `Subject`: 主語 (EntityID)
    *   `Predicate`: 述語
    *   `Object`: 目的語 (EntityID or Value)
    *   `Timestamp`: タイムスタンプ (ISO形式 or 自然言語)
    *   `Location`: 場所 (EntityID)
*   **階層構造:**
    *   `Layer`: 命題の階層 (`Fact`, `Information`, `Interpretation`)
        *   `Fact`: 客観的事実。世界の揺るぎない真実。
        *   `Information`: 登場人物の証言やメディアの報道。嘘、誤解、誇張を含む可能性があります。
        *   `Interpretation`: 事実や情報からの解釈。「暑い」「不自然だ」といった質的な意味合い。
*   **モダリティと属性:**
    *   `Source`: 情報源 (EntityID)
    *   `Modality`: 発話様式 (`assert`, `report`, `gossip`, `belief`)
    *   `Certainty`: 確実性 (0.0 - 1.0 の数値)
    *   `Distortion`: 歪曲の種類 (`Lies`, `Exaggeration`, `Vague`)
*   **コンテンツタグ:**
    *   `ContentTag`: テキストの役割 (`Flavor`, `SeriesCommon`, `Logic_Strong`, `Logic_Weak`, `Ambiguity_Strong`, `Ambiguity_Weak`)
*   **定義強度:**
    *   `DefinitionStrength`: 物語の根幹をなす要素かどうかの強度 (1-10)。数値が低いほど他の要素によって上書きされやすくなります。

##### 2.3. テキスト構文

角括弧 `[]` を用いて変数を埋め込み、動的な文章生成を実現します。

*   **単純置換:** `[char_A]は[loc_A]にいた。`
*   **配列・選択:** `[[長い、][静かな、]][九月]の午後。` -> "長い、九月の午後" や "静かな、九月の午後" などを生成。
*   **アクションキー (多言語対応):** `[char_A]は[char_B]に[action_verb_loud_call]。`

#### 3. シナリオ記述・管理

Google Sheets を活用し、ライターが直感的に作業できる制作環境を構築します。

*   **`Entities`シート:** 登場人物、場所、アイテムなどの固有名詞を定義します (`EntityID`, `Type`, `Name`, `Properties (JSON)`)。
*   **`Propositions`シート:** すべての命題ユニットを記述します。上記2.2のデータ構造をカラムに持ちます。
*   **`StoryTemplate`シート:** 章やシーンごとの大まかな流れを、コンテンツタグの組み合わせで定義します (例: `Scene01: (◎ + ▲) + (▲ + ▲ + △ + ◯) + ◎`)。
*   **`CharacterVoice`シート:** キャラクターごとの一人称、語尾、他者への呼称などを定義し、セリフ生成時に自動反映させます。
*   **`Localization`シート:** アクションキーなどに対応する各国語の翻訳テキストを管理します。

#### 4. 開発計画

*   **フェーズ1: プロトタイプ開発 (1-2ヶ月)**
    *   **目標:** 基本的なストーリー生成機能の実装。
    *   **タスク:** UnityでのGoogle Sheets読み込み、単純な変数置換を行う構文解析、最小限のUIでのテキスト表示。
*   **フェーズ2: コアシステム強化 (2-3ヶ月)**
    *   **目標:** 論理整合性システムの構築と複雑な構文への対応。
    *   **タスク:** 命題ユニットの完全なデータ構造実装、基本的な矛盾検出ロジック、コンテンツタグと定義強度に基づいたナラティブ生成機能の開発。
*   **フェーズ3: コンテンツ制作とツール整備 (3-4ヶ月)**
    *   **目標:** ライターが実際にシナリオを制作できる環境の提供。
    *   **タスク:** サンプルストーリーデータセットの作成、ライター向けマニュアルの整備、Google Sheets上の入力支援機能（プルダウン、条件付き書式等）の実装。
*   **フェーズ4: 統合と品質向上 (継続)**
    *   **目標:** 生成される物語の品質向上と、全体的なデバッグ。
    *   **タスク:** 生成された物語のテストとフィードバック収集、表現の揺らぎや接続詞選択ロジックの改善、UI/UXの向上。

#### 5. 技術的課題と対策

*   **課題1: 論理的整合性の担保**
    *   **対策:** `Layer`と`Certainty`を用いて情報の信頼性を明確化。矛盾発生時は、`Fact`レイヤーを最優先し、`Certainty`の低い情報を棄却・変更するルールセットを構築します。
*   **課題2: 自然な文章生成**
    *   **対策:** 文脈に応じた接続詞の自動挿入、表現パターンの複数登録、`CharacterVoice`シートによる口調の自動反映など、多角的なアプローチで機械的な印象を払拭します。
*   **課題3: データ管理のスケーラビリティ**
    *   **対策:** まずはGoogle Sheetsで迅速に開発を進め、将来的にはパフォーマンス向上のため、より高速なデータベース（SQLiteやJSONファイルなど）への移行を計画に含めます。

---

#### 6. フェーズ別 詳細開発計画

##### フェーズ1: プロトタイプ開発 (目安: 1-2ヶ月)

*   **目標:** Google Sheetsから読み込んだデータに基づき、基本的な文章を動的に生成するプロトタイプを完成させる。
*   **ステップ:**
    1.  **環境構築 (手数: 小)**
        *   Unityプロジェクトを新規作成。
        *   テキスト表示用の基本的なUI（テキストボックス、進行ボタン）をシーンに配置。
    2.  **Google Sheets連携 (手数: 中)**
        *   公開されたGoogle SheetsのデータをCSV形式で読み込むためのC#スクリプト (`DatabaseManager`) を作成。
        *   `Entities`シートと、ごく単純な`Propositions`シート（例: `ID`と`Text`カラムのみ）を読み込む機能を実装。
    3.  **基本データモデル定義 (手数: 小)**
        *   C#で`Entity`クラス（ID, 名前）と、ごく単純な`Proposition`クラスを定義。
    4.  **単純な構文解析 (手数: 中)**
        *   `NarrativeParser`クラスを作成。
        *   `[変数]`を対応する固有名詞に置換する、基本的な文字列置換機能を実装。
    5.  **コアゲームフロー実装 (手数: 小)**
        *   ゲームの進行を管理する`GameManager`を作成。
        *   ボタンクリックに応じて、`Propositions`シートから次の文章を取得し、解析・表示する一連の流れを実装。
*   **このフェーズの成果物:** Google Sheets上のテンプレート文章と固有名詞を組み合わせ、Unity上で1つの完成した文章を表示できる最小限のアプリケーション。

##### フェーズ2: コアシステム強化 (目安: 2-3ヶ月)

*   **目標:** 論理整合性の判定と、より複雑な構文に対応したストーリー生成エンジンの骨子を構築する。
*   **ステップ:**
    1.  **完全なデータモデル実装 (手数: 中)**
        *   仕様書(2.2)に沿って、`Proposition`クラスを拡張（`Layer`, `Modality`, `Certainty`, `ContentTag`等を追加）。
        *   `DatabaseManager`がこれらの詳細なデータを読み込めるようにパーサーを強化。
    2.  **高度な構文解析 (手数: 大)**
        *   `NarrativeParser`を改良し、`[[A][B]]`のような配列・選択構文に対応。
        *   多言語対応を見据えた`[action_key]`形式の構文解析ロジックを追加。
    3.  **論理整合性エンジン (v1) (手数: 大)**
        *   `LogicEngine`クラスを新規作成。
        *   `Fact`レイヤーの命題を「絶対的な事実」として保持する機能を実装。
        *   事実ベースでの単純な矛盾（例: 同一人物が同時刻に複数箇所に存在する）を検出するロジックを実装。
    4.  **ストーリーテンプレート機能 (手数: 中)**
        *   `StoryTemplate`シートを読み込み、`ContentTag`に基づいた物語の構成を解釈する機能を実装。
        *   `GameManager`がテンプレートに従い、適切な`Proposition`を選択して物語を進行させるように改良。
*   **このフェーズの成果物:** テンプレートに基づき、基本的な論理矛盾を回避しながら、より多様な表現で短い物語を自動生成できるアプリケーション。

##### フェーズ3: コンテンツ制作とツール整備 (目安: 3-4ヶ月)

*   **目標:** ライターが効率的に、かつ意図通りに物語を制作できるための環境とサンプルを提供する。
*   **ステップ:**
    1.  **Google Sheets制作支援 (手数: 中)**
        *   `Layer`や`Modality`等の項目にプルダウンリストを設定したテンプレートシートを作成。
        *   入力ミスを防ぐため、条件付き書式（例: `Fact`なのに`Source`が入力されているとハイライト）を設定。
        *   ライター向けの詳細な仕様・記述方法マニュアルを作成。
    2.  **サンプルシナリオ作成 (手数: 大)**
        *   システムの全機能（嘘、矛盾、伏線など）を網羅した、小規模なミステリーシナリオのデータ一式を作成。
    3.  **キャラクター個性表現 (手数: 中)**
        *   `CharacterVoice`シートを読み込み、セリフ生成時にキャラクターの口調（一人称、語尾など）を自動で反映させる機能を実装。
    4.  **多言語対応システム (手数: 中)**
        *   `Localization`シートを読み込み、`[action_key]`を各言語のテキストに変換するシステムを構築。
*   **このフェーズの成果物:** ライターがGoogle Sheets上で制作したシナリオを、意図した通りの論理構造とキャラクター表現で実行できる、実用的な制作パイプライン。

##### フェーズ4: 統合と品質向上 (継続的)

*   **目標:** 生成される物語の「自然さ」「面白さ」を向上させ、完全なゲームとしての体験を磨き上げる。
*   **ステップ:**
    1.  **高度な論理操作 (手数: 大)**
        *   `△ + △ ≒ ▲` のような、曖昧性要素の組み合わせによる論理変化システムを実装。
        *   `DefinitionStrength`に基づき、物語の展開によって一部の定義が上書きされる動的な世界を実現。
    2.  **自然言語生成の強化 (手数: 大)**
        *   文脈に応じて適切な接続詞（「しかし」「そして」等）を自動選択・挿入するロジックを開発。
        *   単調さを避けるため、同じ意味内容を異なる文章構造で表現するバリエーションを追加。
    3.  **UI/UXの向上 (手数: 中)**
        *   立ち絵、名前表示、選択肢など、ノベルゲームとして必要なUI要素を本格的に実装。
        *   プレイヤーの選択が、その後の`Proposition`選択ロジックに影響を与えるインタラクションを実装。
    4.  **パフォーマンス最適化 (手数: 中)**
        *   データ読み込みや構文解析のボトルネックを特定し、処理を効率化。
        *   （必要に応じて）製品版ではGoogle Sheetsからローカルデータベース（SQLite等）に移行する処理を実装。
*   **このフェーズの成果物:** プレイヤーの没入感を高める演出と、より自然で質の高い文章生成能力を備えた、完成度の高いノベルゲーム。

---

### 7. 高度なナラティブ機能の拡張計画

ご提案いただいた将来構想に基づき、システムの拡張計画を以下に詳述します。これらは主にフェーズ2以降で段階的に実装されることを想定しています。

#### 7.1. 多様な情報を持つProposition

現在の`id, rawText`という単純な構造から、よりリッチな情報を持つ構造へと拡張します。これにより、一行の命題が文脈を持つようになります。

**Propositionsシートの拡張例:**

| id   | layer | source | rawText                               | modality | certainty | timestamp | reason |
| :--- | :---- | :----- | :------------------------------------ | :------- | :-------- | :-------- | :----- |
| f_01 | Fact  | System | [char_A]は[loc_A]にいた。             | -        | 1.0       | D1_2200   | -      |
| u_01 | Info  | char_B | 「[char_A]が[loc_A]で何か探していたぞ」 | gossip   | 0.7       | D1_2210   | f_01   |
| i_01 | Interp| char_C | [char_B]の話は少し大げさに聞こえる。  | belief   | 0.5       | D1_2215   | u_01   |

*   **layer:** `Fact`(事実), `Info`(情報), `Interpretation`(解釈) の階層。
*   **source:** 情報源（誰が言ったか/どこに書いてあったか）。
*   **modality, certainty:** 発話の様式と確実性。
*   **timestamp:** イベントの発生時刻。
*   **reason:** この命題が成り立つ根拠（他の命題IDを参照）。「何が理由で」の部分です。

これにより、「`f_01`という事実があり、それを元に`char_B`が`u_01`と噂話を語り、それを聞いた`char_C`が`i_01`という感想を抱いた」という因果関係を表現できます。

#### 7.2. カスタム変数と論理タグ

文章内に、表示されるテキスト以外のメタデータを「論理タグ」として埋め込めるようにします。これにより、シート上で「強度・速さ」などを規定できます。

**記述例:**

`「[action:急いで][char_A]は部屋を出ていった。[weather:大雨]のせいだろうか。」`

*   `[action:急いで]` や `[weather:大雨]` といったタグは、直接文章には表示されませんが、パーサーによって解釈されます。
*   `LogicEngine`はこれらのタグを読み取り、「天気が大雨」で「行動が急いでいる」という状況を認識します。
*   これにより、「大雨の日に急いで外に出るのは不自然だ」といった、より高度な状況判断や、NPCの反応の変化（例：「あんな雨の中、田中さん急いでどこ行ったのかしら」）を自動生成するトリガーとして利用できます。

#### 7.3. キャラクター別知識ベース（信念世界モデル）

ご指摘の通り、キャラクターが「何をどう思っているか」を個別に管理することは、物語の深さに不可欠です。これを実現するため、キャラクター別の信念シートを導入します。

**`Beliefs_char_A` (田中が信じていること) シート例:**

| id   | rawText                    | certainty | type    |
| :--- | :------------------------- | :-------- | :------ |
| u_02 | [char_B]は信頼できない。   | 0.8       | Belief  |
| f_01 | 昨晩、自分は[loc_A]にいた。 | 1.0       | Memory  |
| r_01 | [u_02]が理由で、[char_B]の話は無視する。 | 1.0 | Rule |


**動作シナリオ:**

1.  プレイヤーが田中(`char_A`)に「鈴木(`char_B`)が昨晩あなたを見たと話していたが？」と尋ねる。
2.  `GameManager`は田中の信念シート`Beliefs_char_A`を参照。
3.  彼は「鈴木は信頼できない(`u_02`)」と強く信じており、「だから彼の話は無視する(`r_01`)」という行動ルールを持っていると判断。
4.  「あの男の言うことはアテにならない」といったセリフを生成する。プレイヤーに提示される情報と、キャラクターの内部的な判断が乖離し、複雑な人間関係が生まれます。

これらの拡張は、シート上でライターが世界の法則、キャラクターの思考、出来事の連鎖を直感的に記述し、それをゲームエンジンが解釈して動的な物語を紡ぎ出すという、本プロジェクトの根幹をなすものです。 