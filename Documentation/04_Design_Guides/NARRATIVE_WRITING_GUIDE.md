# NarrativeGen ライターズガイド

このガイドは、`NarrativeGen` システムを使って物語を執筆するために、`Propositions.csv` ファイル、特に `reason` 列をどのように記述するかを解説します。

## 基本コンセプト：`reason` 列は「監督の指示書」

- **`content` 列**: プレイヤーの画面に**表示される**テキスト（セリフ、ナレーション）。
- **`reason` 列**: プレイヤーの画面には**表示されない**、`LogicEngine` への内部的な命令。

`LogicEngine` は `content` の意味を理解しません。`reason` に書かれた命令だけを読んで実行します。

---

## 使える命令（全4種類）

`reason` 列には、以下の4つの命令をカンマ区切りで複数記述できます。

| 命令 | 書式 | 意味 |
| :--- | :--- | :--- |
| **拡張** | `expands:[ID]` | この行の次に、指定したIDの行を再生する。 |
| **状態設定** | `set_state:[変数名]=[値]` | 物語の状態を記録する。（例：`set_state:door_locked=true`） |
| **実行条件** | `requires:state:[変数名]==[値]` | 指定した状態が記録されている場合のみ、この行を再生する。 |
| **選択肢** | `CHOICE:[テキスト]>[ID]` | プレイヤーに選択肢を提示する。セミコロン区切りで複数指定可能。 |

---

## 実践レシピ集：命令を組み合わせて物語を作る

### レシピ1：一本道の物語を作る

一番シンプルな、A→B→Cと進む物語です。`expands` を使って順番を指定します。

**CSVの記述例:**
```csv
id,timestamp,speakerId,content,reason
1,10,SYSTEM,"古い屋敷の前に立っている。","expands:2"
2,11,char_A,"（きしむ扉を開けて、中に入った）",expands:3
3,12,SYSTEM,"ひんやりとした空気が肌を撫でた。",""
```
- **解説**:
    - ID:1 が表示された後、`expands:2` によって ID:2 が再生リストに追加されます。
    - 同様に ID:2 の後、ID:3 が再生されます。
    - ID:3 には `reason` がないため、ここで物語は一旦終了します。

### レシピ2：「鍵のかかった扉」のロジック

「鍵を見つける」→「扉を開ける」という古典的なギミックです。`set_state` と `requires` を使います。

**CSVの記述例:**
```csv
id,timestamp,speakerId,content,reason
10,100,SYSTEM,"あなたは書斎を調べている。机の上に錆びた鍵を見つけた。","set_state:has_key=true"
...
20,200,SYSTEM,"廊下の突き当りに、頑丈な扉がある。","CHOICE:扉を開けてみる>21"
21,201,SYSTEM,"鍵を使って扉を開けた。中から古い日記を見つけた。","requires:state:has_key==true"
22,202,SYSTEM,"扉には鍵がかかっていて開かない。","requires:state:has_key!=true"
```
- **解説**:
    - ID:10 で `has_key=true` という状態が記録されます。
    - プレイヤーが「扉を開けてみる（ID:21へ）」を選択した時、`LogicEngine` は条件を確認します。
        - **鍵を持っている場合 (`has_key==true`)**: `requires` を満たすため、ID:21「鍵を使って扉を開けた」が表示されます。
        - **鍵を持っていない場合 (`has_key`が`true`ではない)**: `requires` を満たさないためID:21は無視され、代わりに`requires:state:has_key!=true` を持つID:22「扉には鍵がかかっていて開かない」が表示されます。（※注: `!=`は「等しくない」という意味です。ID:22のようなフォールバックを記述する必要があります）

### レシピ3：キャラクターの「心の声」を表現する

ある出来事を見たキャラクターが、それについてどう思ったかを表現します。`interpretation_for` を使います。

**CSVの記述例:**
```csv
id,timestamp,speakerId,content,reason
30,300,SYSTEM,"暖炉の火が、パチパチと音を立てて燃えている。","interpretation_for:30"
31,301,char_A,"（あの火を見ていると、なぜか祖父のことを思い出す…）",
```
- **解説**:
    - ID:30 が表示された後、`reason` に `interpretation_for:30` が書かれている ID:31 が自動的に再生リストに追加されます。
    - これにより、出来事（暖炉の火）と、それに対するキャラクターの反応（心の声）を自然に繋げることができます。

### レシピ4：選択肢による分岐

プレイヤーの選択によって、その後の展開が大きく変わる場面を作ります。`CHOICE` を使います。

**CSVの記述例:**
```csv
id,timestamp,speakerId,content,reason
40,400,char_B,"さあ、どうする？この街に留まるか、それとも次の街へ向かうか。","CHOICE:ここに留まる>41;次の街へ向かう>51"

// パターンA: 街に留まる
41,401,SYSTEM,"あなたは情報屋の提案を受け入れ、この街でもう少し調査を続けることにした。",expands:42
...

// パターンB: 街を出る
51,501,SYSTEM,"あなたは情報屋に別れを告げ、朝日と共に街を出発した。",expands:52
...
```
- **解説**:
    - ID:40 が表示されると、UIに「ここに留まる」「次の街へ向かう」という2つのボタンが表示されます。
    - 「ここに留まる」をクリックすると ID:41 の行が再生され、物語はパターンAに分岐します。
    - 「次の街へ向かう」をクリックすると ID:51 の行が再生され、物語はパターンBに分岐します。
    - `CHOICE` はセミコロン `;` で区切ることで、複数の選択肢を一つの行に定義できます。

---

このガイドを参考に、これらの命令を組み合わせることで、より複雑でインタラクティブな物語を構築することが可能です。 