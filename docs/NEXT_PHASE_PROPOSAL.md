# Web Tester 次フェーズ開発提案

## 概要
Phase 1〜4（基本機能・効率化・検証）完了に基づく、次フェーズの開発提案

## 策定日
2025-11-11（初版）  
**更新日**: 2025-12-06

---

## 現在の完了状況

### ✅ Phase 1: 完了
- SVGアイコンシステム
- カラーパレット機能（6種類）
- クイックノード作成
- 選択肢一括編集

### ✅ Phase 3: 完了（先行実装）
- ノードコピー＆ペースト（Ctrl+C/V）
- スニペット機能（保存・挿入・削除）
- 検索・フィルタ機能（到達不能/孤立/フラグ使用等）
- カスタムテンプレート（localStorage 保存）

### ✅ Phase 4: 部分完了
- リアルタイムプレビューパネル ✅
- モデル検証ツール ✅（自己参照/デッドエンド/未定義フラグ検出）
- マルチエンディング可視化 ⏳（未実装）

### ✅ 追加実装
- Mermaid プレビュー（M キーでトグル）
- 統一キーバインドシステム
- SaveManager による保存/読み込み
- デザイナー拡張レキシコン

---

## Phase 2: Mermaid風グラフエディタ（集中開発）

### 目的
現在のリスト形式 GUI エディタを補完する、ビジュアルグラフエディタの追加

### 既存 GUI エディタとの棲み分け

| 観点 | リスト形式（現行） | グラフ形式（Phase 2） |
|------|-------------------|----------------------|
| 用途 | 詳細なプロパティ編集 | 構造の俯瞰・接続編集 |
| 強み | テキスト編集が高速 | 全体構造が一目瞭然 |
| 操作 | フォーム入力 | ドラッグ＆ドロップ |
| 配置 | 「ノードグラフ」タブを置換 | 同左 |

**方針**: 両方を切り替え可能にし、用途に応じて使い分け

### 主要機能

#### 1. 自動レイアウトアルゴリズム
**技術選定：Dagre.js**
- 階層型レイアウト（トップダウン）
- ノード追加時の自動配置
- 衝突回避

#### 2. ドラッグ＆ドロップ物語構成
- ツールパレットからノードタイプをドラッグ
- キャンバスにドロップして作成
- ノード間をドラッグして接続作成
- グリッドスナップ機能

#### 3. ビジュアルノードタイプ
```
[開始] → [会話] → [選択] → [分岐]
                       ↓
                    [エンディング]
```

ノードタイプごとに色分け：
- 開始：緑 / 会話：青 / 選択：黄 / 分岐：オレンジ / 終了：赤

#### 4. インライン編集
- ノードダブルクリックで即座に編集
- モーダル不要
- リアルタイムプレビュー

#### 5. ミニマップ
- 大規模グラフの全体把握
- クリックで移動

### 現在のコード構造との統合

```
apps/web-tester/src/ui/
├── graph.js              ← 現行 D3.js グラフ（置換対象）
├── gui-editor.js         ← リスト形式エディタ（維持）
├── node-renderer.js      ← ノードカード描画（維持）
└── graph-editor/         ← 【新規】Phase 2 用ディレクトリ
    ├── GraphEditorManager.js   ← メインマネージャー
    ├── DagreLayoutEngine.js    ← Dagre.js ラッパー
    ├── CanvasRenderer.js       ← SVG/Canvas 描画
    ├── NodeComponent.js        ← ノード UI コンポーネント
    ├── EdgeComponent.js        ← エッジ UI コンポーネント
    └── ToolPalette.js          ← ツールパレット
```

### 実装計画（更新版）

#### ステップ1：基盤構築（2-3日）
- [ ] `graph-editor/` ディレクトリ作成
- [ ] Dagre.js インストール・統合
- [ ] `GraphEditorManager` クラス作成
- [ ] 「ノードグラフ」タブで新エディタを表示

#### ステップ2：ノード操作（2-3日）
- [ ] `CanvasRenderer` でノード描画
- [ ] `ToolPalette` 実装
- [ ] ドラッグ＆ドロップでノード作成
- [ ] ノードタイプ別スタイル

#### ステップ3：エッジ（選択肢）操作（1-2日）
- [ ] ノード間ドラッグで接続作成
- [ ] 選択肢ラベル表示
- [ ] 条件・効果のインジケータ

#### ステップ4：インライン編集（1-2日）
- [ ] ノードダブルクリックで編集モード
- [ ] テキスト・選択肢のインライン編集
- [ ] `GuiEditorManager` との状態同期

#### ステップ5：高度機能（1-2日）
- [ ] ミニマップ
- [ ] ズーム・パン
- [ ] グリッドスナップ
- [ ] 複数選択・一括移動

**合計推定時間：7-11日**

### UI設計

```
┌────────────────────────────────────────────────────┐
│ [ファイル] [編集] [表示] [ツール]    [設定] [ヘルプ] │
├────────────────────────────────────────────────────┤
│ ツールパレット │  キャンバス                        │
│ ┌──────────┐  │                                   │
│ │ 🟢 開始   │  │         [開始]                    │
│ │ 🔵 会話   │  │            │                      │
│ │ 🟡 選択   │  │         [会話1]                   │
│ │ 🟠 分岐   │  │         /     \                   │
│ │ 🔴 終了   │  │    [選択A]  [選択B]              │
│ │ ⚪ 情報   │  │        │        │                │
│ └──────────┘  │    [終了]   [終了]               │
│              │                                   │
├──────────────┴───────────────────────────────────┤
│ プロパティパネル                                   │
│ ノードID: [conversation_1]                        │
│ テキスト: [__________________________________]    │
│ 選択肢: [追加] [削除]                             │
└────────────────────────────────────────────────────┘
```

---

## Phase 3: ストーリー作成効率化（拡張）✅ 完了

> **実装完了**: 2025-12-02

### ✅ 1. ノードコピー＆ペースト
- `Ctrl+C` / `Ctrl+V` で動作
- 選択肢も含めて完全コピー
- ID自動採番（`nodeId_copy`, `nodeId_copy2` ...）
- 実装: `GuiEditorManager.copyNode()` / `pasteNode()`

### ✅ 2. スニペット機能
- ノード構成の保存・再利用
- localStorage 永続化
- 実装: `GuiEditorManager.saveAsSnippet()` / `insertFromSnippet()`

### ✅ 3. 検索・フィルタ機能
- 全文検索（ID、テキスト、選択肢）
- フィルタ: 到達不能 / 孤立 / フラグ使用 / リソース使用 / 選択肢なし
- デバウンス付き検索入力
- 実装: `GuiEditorManager.searchNodes()` / `filterNodes()`

### ✅ 4. カスタムテンプレート
- ユーザー独自テンプレートの作成・保存
- クイックノード作成モーダルに統合
- localStorage 永続化
- 実装: `GuiEditorManager.saveAsCustomTemplate()`

### 5. バッチ操作強化 ⏳（部分実装）
- 選択肢一括編集: ✅
- ノードテキスト一括置換: ⏳
- 正規表現サポート: ⏳

---

## Phase 4: プレビュー＆検証機能 ✅ 部分完了

> **実装完了**: 2025-12-03

### ✅ 1. リアルタイムプレビュー
- GUI エディタ右側にプレビューパネル
- 選択ノードのテキスト・選択肢表示
- 選択肢クリックで遷移先へジャンプ
- スタートノードからのパス表示（BFS）
- 実装: `GuiEditorManager.updateLivePreview()`

### 2. マルチエンディング可視化 ⏳（未実装）
- 全エンディングパスを自動抽出
- ツリー構造で表示
- 各エンディングへの到達条件表示

### ✅ 3. モデル検証ツール
- 到達不可能ノード検出
- 自己参照検出
- デッドエンド検出
- 未定義フラグ検出
- 空テキストノード検出
- 実装: `ModelValidator` / `ValidationPanel`

---

## Phase 5: コラボレーション＆エクスポート機能

### 1. バージョン管理統合
- Gitライクな変更履歴
- コミット・ロールバック機能
- 差分表示

### 2. マルチユーザー編集（将来）
- リアルタイムコラボレーション
- ロック機能（編集中ノードのロック）
- 変更通知

### 3. エクスポート機能拡張
**現在：** JSON, CSV

**追加：**
- Twine互換形式
- Inkフォーマット
- Yarn Spinner形式
- Excel/Google Sheets
- PDF（フローチャート）

---

## Phase 6: パフォーマンス＆UX改善

### 1. 大規模モデル対応
- 仮想化スクロール強化
- 遅延読み込み
- インクリメンタル保存

### 2. ショートカット拡張
**追加予定：**
- `Ctrl+Z` / `Ctrl+Y`: 元に戻す/やり直す
- `Ctrl+F`: 検索
- `Ctrl+D`: 選択複製
- `Delete`: ノード削除
- `Space`: パンモード切り替え

### 3. ツールチップ＆ヘルプ
- インタラクティブチュートリアル
- 各機能のツールチップ
- ヘルプドキュメント統合

---

## 優先度マトリクス（2025-12-06 更新）

| フェーズ | 機能 | 状態 | 優先度 | 工数 |
|---------|------|------|-------|------|
| Phase 2 | Mermaid風グラフエディタ | ⏳ 未着手 | **高** | 7-11日 |
| Phase 3 | コピー＆ペースト | ✅ 完了 | - | - |
| Phase 3 | スニペット | ✅ 完了 | - | - |
| Phase 3 | 検索・フィルタ | ✅ 完了 | - | - |
| Phase 3 | カスタムテンプレート | ✅ 完了 | - | - |
| Phase 3 | バッチ一括置換 | ⏳ 部分 | 中 | 1-2日 |
| Phase 4 | リアルタイムプレビュー | ✅ 完了 | - | - |
| Phase 4 | モデル検証ツール | ✅ 完了 | - | - |
| Phase 4 | マルチエンディング可視化 | ⏳ 未着手 | 中 | 2-3日 |
| レキシコン | GUI クイック追加 | ⏳ 未着手 | 中 | 1日 |
| レキシコン | モデル埋め込み | ✅ 完了 | - | - |
| Phase 5 | バージョン管理 | ⏳ 未着手 | 低 | 5-7日 |
| Phase 5 | エクスポート拡張 | ⏳ 未着手 | 中 | 3-5日 |

---

## 推奨実装順序（2025-12-06 更新）

### 即時対応（テスト・安定化）
1. **手動テスト実施**
   - `docs/GUI_EDITOR_TEST_GUIDE.md` に沿ったテスト
   - Mermaid プレビュー動作確認
   - Save/Load 動作確認

2. **リモート反映**
   - `git push origin master`

### 次期実装（1-2週間）
1. **Phase 2: Mermaid風グラフエディタ**
   - ストーリー構造の可視化
   - ドラッグ＆ドロップ編集
   - 工数: 7-11日

2. **レキシコン拡張**
   - GUI クイック追加
   - モデル埋め込み
   - 工数: 2日

### 将来実装（1ヶ月以降）
1. **Phase 4: マルチエンディング可視化**
2. **Phase 3: バッチ一括置換（正規表現）**
3. **Phase 5: エクスポート機能拡張**
4. **Phase 5: バージョン管理**

---

## ユーザーテストポイント

Phase 1実装後、以下を確認：

### 定量評価
- [ ] ノード作成時間（Phase 1 vs 旧方式）
- [ ] エラー発生率
- [ ] ユーザー満足度スコア

### 定性評価
- [ ] UIの直感性
- [ ] 機能の発見しやすさ
- [ ] 学習曲線

### フィードバック収集
- [ ] 最も使う機能は？
- [ ] 使いにくい点は？
- [ ] 追加してほしい機能は？

---

## 技術的考慮事項

### Mermaid風グラフエディタ
**技術スタック：**
- Dagre.js：レイアウト計算
- 現行D3.js：描画エンジン（再利用）
- TypeScript：型安全性

**移行戦略：**
1. 新エディタを別タブで実装
2. 旧グラフと並行提供
3. ユーザーテスト後に統合判断

### パフォーマンス目標
- 500ノードモデルで60fps維持
- レイアウト計算1秒以内
- メモリ使用量200MB以下

---

## まとめ

### 次の一手
**最優先：Phase 2 - Mermaid風グラフエディタ**

理由：
1. ストーリー作成の中核機能
2. ユーザー体験の劇的改善
3. 他機能の基盤となる

### 期待される効果
- ストーリー作成時間：**50%削減**
- エラー発生率：**70%削減**
- ユーザー満足度：**大幅向上**

### リスクと対策
**リスク：** 大規模実装による遅延
**対策：** 段階的実装、早期テスト、フィードバックループ

---

## フィードバックをお待ちしています

Phase 1の使用感を確認後、Phase 2の詳細設計に進みます。

**重要な質問：**
1. Phase 1の機能は期待通りですか？
2. 最も重要だと思う次の機能は？
3. Mermaid風グラフエディタに期待する機能は？
