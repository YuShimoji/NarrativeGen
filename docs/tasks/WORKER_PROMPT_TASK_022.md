# Worker Prompt: TASK_022 GUIエディタ高度バッチ操作機能実装

## タスク概要

GUIエディタに高度バッチ操作機能を実装してください。正規表現サポート、置換前プレビュー、高度フィルタリング、操作履歴管理を追加し、ストーリー編集の効率を大幅に向上させます。

## 前提条件

- TASK_016（GUIエディタのバッチテキスト置換機能）が完了済み
- 基本的なバッチ操作UIが実装済み
- localStorageによる設定保存機能が実装済み

## 実装範囲

### 1. 正規表現サポート
- 置換文字列での正規表現使用（JavaScript RegExp）
- キャプチャグループの利用（$1, $2など）
- 大文字・小文字の区別オプション（iフラグ）
- グローバルマッチオプション（gフラグ）
- 正規表現の文法チェックとエラー表示

### 2. 置換前プレビュー機能
- 置換対象のハイライト表示（黄色背景）
- 置換結果のリアルタイムプレビュー
- 置換前後の差分表示（サイドバイサイド）
- プレビューの更新タイミング（入力後500ms遅延）
- プレビューのパフォーマンス最適化

### 3. 高度フィルタリング
- ノードタイプによるフィルタ（passage/choice/end等）
- 条件付きフィルタ（特定フラグを持つノード等）
- 複数条件の組み合わせ（AND/OR）
- カスタムフィルタの保存・読み込み
- フィルタ結果の件数表示

### 4. 操作履歴管理
- バッチ操作の履歴保存（最大50件）
- 操作のUndo/Redo機能（Ctrl+Z/Ctrl+Y）
- 操作のエクスポート・インポート（JSON形式）
- 履歴のクリア機能
- 操作の詳細情報表示

## 技術要件

### ファイル構成
- `apps/web-tester/src/ui/batch-editor.js` - メイン実装ファイル
- `apps/web-tester/src/ui/preview-panel.js` - プレビューパネル
- `apps/web-tester/src/utils/filter-engine.js` - フィルタリングエンジン
- `apps/web-tester/src/utils/history-manager.js` - 履歴管理

### データ構造
```javascript
// 操作履歴のデータ構造
{
  id: "uuid",
  timestamp: "2026-01-15T02:06:00Z",
  type: "replace",
  pattern: "正規表現パターン",
  replacement: "置換文字列",
  options: { global: true, ignoreCase: false },
  affectedNodes: 15,
  filter: { nodeType: "passage", flags: ["test"] }
}
```

### パフォーマンス要件
- 1000ノードの置換プレビューが1秒以内に完了
- 正規表現の評価タイムアウト（5秒）
- 履歴管理のメモリ使用量を最小化

## 実装手順

1. **正規表現エンジン実装**
   - RegExpオブジェクトの安全な使用
   - エラーハンドリングとバリデーション
   - パターンの文法チェック

2. **プレビューパネル実装**
   - リアルタイムプレビューの更新機構
   - 差分表示のUIコンポーネント
   - パフォーマンス最適化（デバウンス）

3. **フィルタリングエンジン実装**
   - 複数条件の評価ロジック
   - フィルタ条件のシリアライズ
   - カスタムフィルタの保存機能

4. **履歴管理実装**
   - 操作の記録と再生
   - Undo/Redoの実装
   - 履歴のエクスポート機能

## 禁止事項

- エンジンコアの仕様変更
- 既存データ形式の破壊的変更
- データベース機能の追加
- eval()やFunction()の使用（セキュリティ上の理由）

## 完了条件（DoD）

- [ ] 正規表現が正しく動作し、エラー表示がされる
- [ ] 置換前プレビューがリアルタイムで表示される
- [ ] 高度フィルタリングが複数条件で動作する
- [ ] 操作履歴のUndo/Redoが動作する
- [ ] 既存バッチ操作機能との統合が完了する
- [ ] 大規模データ（1000ノード）でパフォーマンス問題がない
- [ ] docs/inbox/にREPORT_TASK_022_*.mdを作成する

## テスト手順

1. サンプルモデル（dragon_quest_v3.csv）を読み込む
2. 正規表現「(dragon|hero)」を「$1-sama」に置換
3. プレビューが正しく表示されることを確認
4. ノードタイプ「passage」でフィルタリング
5. 置換を実行し、結果を確認
6. Ctrl+ZでUndoし、元に戻ることを確認
7. 履歴のエクスポート・インポートを確認

## 報告要件

実装完了後、以下の内容を含むレポートを作成してください：

1. 実装内容の詳細
2. 正規表現のテストケースと結果
3. プレビュー機能のパフォーマンス測定
4. フィルタリング機能の動作確認
5. 既存機能への影響評価
6. ユーザビリティの改善点

レポートは `docs/inbox/REPORT_TASK_022_YYYYMMDD.md` として保存してください。
