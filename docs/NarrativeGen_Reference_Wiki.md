# NarrativeGen Web Tester リファレンスWiki

## 概要

NarrativeGen Web Testerは、インタラクティブなノベル/アドベンチャーゲームの作成・テストを支援するWebアプリケーションです。条件分岐、変数管理、AI支援などの機能を備えています。

## 基本的な使い方

### 1. モデルの読み込み

#### サンプルモデルの使用
1. アプリケーション起動後、ドロップダウンからサンプルモデルを選択
2. 「開始」ボタンをクリックしてセッションを開始

#### カスタムモデルの読み込み
1. JSONファイルをドラッグ＆ドロップ、または「ファイルを選択」ボタンで読み込み
2. モデルが自動的に検証され、問題があればエラーが表示されます

#### CSVからのインポート
1. CSVファイルをドラッグ＆ドロップ、またはファイル選択
2. プレビューを確認してインポート実行

### 2. ストーリーの実行

#### 基本操作
- **選択肢の選択**: 表示された選択肢をクリックしてストーリーを進めます
- **自動進行**: 条件を満たす選択肢が1つしかない場合、自動的に進行します

#### タブの切り替え
- **ストーリータブ**: 現在のストーリーと選択肢を表示
- **グラフタブ**: ノード間の接続関係を視覚化
- **デバッグタブ**: フラグ、リソース、変数の状態を確認・編集
- **AIタブ**: AI支援機能を使用

### 3. 条件分岐システム

#### 条件の種類

##### 基本条件
- **フラグ条件**: `flag:key=value` (真偽値)
- **リソース条件**: `resource:key>=100` (数値比較)
- **時間条件**: `timeWindow:1-10` (時間範囲)
- **変数条件**: `variable:name==太郎` (文字列比較)

##### 変数条件の演算子
- `==` : 等しい
- `!=` : 等しくない
- `contains` : 含む
- `!contains` : 含まない

##### 複合条件
- **AND条件**: `and(flag:hasKey=true;resource:hp>0)`
- **OR条件**: `or(flag:hasSword=true;flag:hasBow=true)`
- **NOT条件**: `not(flag:isDead=true)`

#### 使用例

```json
{
  "conditions": [
    {
      "type": "and",
      "conditions": [
        {"type": "flag", "key": "hasSword", "value": true},
        {"type": "variable", "key": "playerClass", "op": "contains", "value": "warrior"}
      ]
    }
  ]
}
```

### 4. 効果システム

#### 効果の種類
- **フラグ設定**: `setFlag:key=true`
- **リソース変更**: `addResource:hp=10`
- **変数設定**: `setVariable:location=forest`
- **シーン移動**: `goto:nextScene`

#### 使用例

```json
{
  "effects": [
    {"type": "setFlag", "key": "visitedForest", "value": true},
    {"type": "addResource", "key": "experience", "delta": 50},
    {"type": "setVariable", "key": "currentLocation", "value": "dark_forest"}
  ]
}
```

### 5. 変数システム

#### テキスト内変数置換
ノードテキストや選択肢テキスト内で変数を参照できます：

- `{flag:key}` : フラグの値
- `{resource:key}` : リソースの値
- `{variable:key}` : 変数の値
- `{nodeId}` : 現在のノードID
- `{time}` : 現在の時間

#### 変数の管理
デバッグタブから変数を直接編集できます：
1. 「変数を編集」ボタンをクリック
2. `key=value` の形式で入力
3. 既存の変数を上書きしたり、新しい変数を追加できます

### 6. AI支援機能

#### OpenAI統合
1. AIタブでプロバイダーを「openai」に設定
2. APIキーを入力して保存
3. モデルを選択（gpt-3.5-turbo, gpt-4など）

#### Ollama統合
1. Ollamaサーバーを起動（デフォルト: http://localhost:11434）
2. AIタブでプロバイダーを「ollama」に設定
3. URLとモデル名を設定

#### AI機能
- **次のノード生成**: AIがストーリーを自動生成
- **テキスト言い換え**: 選択肢テキストをAIが言い換え

### 7. グラフ視覚化

#### 表示設定
- **ノード形状**: 円形/四角形を選択
- **フォントサイズ**: ノードラベルと条件ラベルのサイズ調整
- **条件表示**: リンク上の条件を表示/非表示

#### プリセット保存
グラフの設定をlocalStorageに保存して再利用できます。

### 8. デバッグ機能

#### 状態確認
- **フラグ**: 真偽値フラグの一覧
- **リソース**: 数値リソースの一覧
- **変数**: 文字列変数の一覧
- **到達可能性**: 現在の状態から到達可能なノード

#### 状態編集
デバッグタブから各状態を直接編集できます。

### 9. GUI編集モード

#### ノード編集
1. 「GUI編集」ボタンで編集モードに入る
2. ノードテキスト、選択肢、ターゲットを編集
3. 「保存」ボタンで変更を適用

#### 制約
- 循環参照のない有効なモデル構造を維持
- 存在しないターゲットノードを参照しない

### 10. CSV形式

#### インポート/エクスポート
NarrativeGenは独自のCSV形式をサポートしています。

#### CSVカラム
- `node_id`: ノードID
- `node_text`: ノード本文
- `choice_id`: 選択肢ID
- `choice_text`: 選択肢テキスト
- `choice_target`: ターゲットノードID
- `choice_conditions`: 条件（セミコロン区切り）
- `choice_effects`: 効果（セミコロン区切り）

#### 条件/効果の書式
- フラグ: `flag:key=value`
- リソース: `resource:key>=100`
- 変数: `variable:key==value`
- 効果: `setFlag:key=true`

## 高度な機能

### カスタムモデル作成

#### JSON形式
```json
{
  "modelType": "adventure-playthrough",
  "startNode": "intro",
  "flags": {"visitedIntro": false},
  "resources": {"health": 100},
  "nodes": {
    "intro": {
      "id": "intro",
      "text": "冒険の始まりだ。{variable:playerName}、準備はいいか？",
      "choices": [
        {
          "id": "c1",
          "text": "準備できた",
          "target": "forest",
          "effects": [
            {"type": "setFlag", "key": "visitedIntro", "value": true}
          ]
        }
      ]
    }
  }
}
```

### エラーハンドリング

#### 一般的なエラー
- **モデル検証エラー**: 循環参照や存在しないターゲット
- **条件パースエラー**: 不正な条件書式
- **AI APIエラー**: APIキーやネットワークの問題

#### トラブルシューティング
1. ブラウザコンソールを確認
2. モデルを検証（「GUI編集」→「保存」）
3. デバッグタブで状態を確認

### パフォーマンス最適化

#### 大規模モデル対応
- 仮想化されたグラフ表示
- 条件評価のキャッシュ
- 遅延読み込み

#### メモリ管理
- 古いログの自動クリーンアップ
- キャッシュサイズ制限

## FAQ

### Q: モデルが読み込めない
A: JSON構文を確認してください。ブラウザコンソールで詳細なエラーメッセージを確認できます。

### Q: 条件が動作しない
A: 条件書式を確認してください。`flag:key=value` の形式になっているかチェック。

### Q: AIが動作しない
A: APIキーが正しく設定されているか確認。Ollamaの場合、サーバーが起動しているかチェック。

### Q: 変数が置換されない
A: 変数が正しく設定されているか確認。`{variable:key}` の形式で参照してください。

## 開発者向け情報

### アーキテクチャ
- **フロントエンド**: Vanilla JavaScript + D3.js
- **エンジン**: TypeScript製コアルーチン
- **ビルド**: ES modules + Webpack

### APIリファレンス
詳細なAPI仕様は `API_ENDPOINTS.md` を参照してください。

### 拡張方法
- カスタム条件タイプの追加
- 新しい効果タイプの実装
- AIプロバイダーの拡張

### 11. セーブ・ロードシステム

#### 基本機能
- **5つのセーブスロット**: 個別のゲーム進行状況を保存
- **オートセーブ**: 30秒ごとに自動保存（セッション中のみ）
- **完全な状態保存**: ノード位置、フラグ、リソース、変数、ストーリーログを保存

#### 操作方法
1. **保存**: デバッグタブでスロット番号を選択し「保存」ボタンをクリック
2. **読み込み**: スロットからデータを読み込んでセッションを復元
3. **クリア**: 不要なセーブデータを削除
4. **オートセーブ**: 自動保存されたデータを手動で読み込み/クリア

#### 保存データ構造
```json
{
  "version": "1.0",
  "timestamp": "2025-11-04T01:43:00.000Z",
  "modelName": "sample_adventure",
  "session": {
    "nodeId": "forest_entrance",
    "flags": {"hasSword": true, "visitedForest": false},
    "resources": {"health": 85, "gold": 150},
    "variables": {"playerName": "太郎", "currentQuest": "dragon_slayer"},
    "time": 45
  },
  "storyLog": ["冒険の始まりだ。...", "森に入った。"]
}
```

#### 注意事項
- セーブデータはブラウザのlocalStorageに保存されます
- 異なるブラウザやプライベートモードではデータが共有されません
- モデル変更時は新しいセッションが開始され、オートセーブが停止します

---

最終更新: 2025年11月4日
