# Phase 2: Mermaid風グラフエディタ 設計ドラフト

## 1. 目的とスコープ

- **目的**
  - ストーリーモデル全体の構造（ノードと遷移）を、Mermaid風のグラフとして直感的に把握・編集できるようにする。
  - デザイナーが「どこが繋がっていないか」「どのエンディングにどう到達するか」を視覚的に確認できるようにする。
- **スコープ（初版）**
  - 既存JSONモデルをグラフに変換して表示
  - ノードの位置は自動レイアウト（Dagre.js）を基本とし、手動微調整は任意
  - ノードクリックで GUI エディタ上のノード選択と連動
  - エッジ（遷移）の可視化（1本の矢印 = 1つのchoice.target）
  - 読み取り専用ビューから開始し、後続フェーズで編集機能（接続変更・ノード追加など）を検討

> **意思決定ポイント A-1**: 初版は「閲覧専用ビュー」としてリリースし、その後に編集機能を追加する段階的アプローチで進めるかどうか。

---

## 2. 想定ユーザーとユースケース

### 2.1 想定ユーザー

- シナリオデザイナー
- テクニカルディレクター / リードデザイナー

### 2.2 代表的なユースケース

1. **全体構造の俯瞰**
   - ノード数が増えたシナリオの「ボリューム感」「分岐の多さ」を一目で把握したい。
2. **デッドエンド・孤立ノードの視覚化**
   - ModelValidator の検出結果と連動し、問題箇所をグラフ上でハイライトしたい。
3. **マルチエンディング経路の確認**
   - 複数エンディング（end_xxx ノード）への経路を色分けして確認したい（Phase 4: マルチエンディング可視化と連携）。
4. **ノード詳細編集へのジャンプ**
   - グラフ上のノードをクリック → GUI エディタ側で該当ノードを選択・編集したい。

---

## 3. 既存機能との関係

- **Mermaidプレビュー（既存）**
  - 現状はテキストベースの Mermaid 記法を生成し、静的なプレビューを表示。
  - 主に「グラフの概要確認」が目的で、インタラクティブな編集機能は持たない。
- **新グラフエディタ（Phase 2）**
  - Mermaid風のビジュアルだが、内部は Dagre.js + SVG/HTML ベースの独自実装。
  - 既存 Meramid プレビューとは当面 **併存** させ、ユーザー評価後に統合・置き換えを検討。

> **意思決定ポイント A-2**: 既存 Mermaid プレビューを完全に置き換えるか、当面は「テキストビュー」と「グラフエディタ」を併存させるか。

---

## 4. UI構成案

- 既存の `graphPanel` タブを拡張して利用
  - 上部ツールバー: ズーム / フィット / レイアウト再計算 / 問題箇所フィルタ
  - 中央: グラフエリア（SVG or Canvas）
  - サイドバー（オプション）: 選択中ノードの情報、検証結果との連動ビュー

### 4.1 ツールバー案

- **表示系**
  - 全体表示（fit to screen）
  - レイアウト再計算
  - 条件・フラグ情報のオン/オフ
- **フィルタ系**
  - 到達不能ノードのみ表示
  - デッドエンドのみ表示
  - 特定フラグ/タグで絞り込み

### 4.2 ノード表示仕様（初版）

- ノードラベル: `nodeId` をメイン、ホバー時に先頭数十文字のテキストをツールチップ表示
- 色分け案:
  - start ノード: 強調色
  - エンディングノード（終端）: 別色
  - 検証エラーありノード: 警告色

---

## 5. 技術スタックとアーキテクチャ

### 5.1 技術スタック候補

- **Dagre.js**: 有向グラフのレイアウト計算
- **既存 GraphManager / D3.js**: 描画レイヤーとして再利用を検討
- TypeScript 型情報: 可能であれば `Packages/engine-ts` の型と整合させる

### 5.2 データフロー概要

1. `appState.model`（JSON）からグラフ用ノード/エッジ一覧を生成
2. Dagre にノード・エッジを渡してレイアウト計算
3. 座標付きノード/エッジを、GraphManager（D3）で描画
4. ノードクリック → GUIエディタ側の `GuiEditorManager.selectNode(nodeId)` を呼び出し連動

> **意思決定ポイント A-3**: 既存GraphManagerを拡張するか、新規の GraphEditorManager を用意するか。

---

## 6. 段階的実装プラン

### フェーズ 2-α: 閲覧専用グラフビュー

- 実装内容
  - JSONモデル → グラフ変換（ノード/エッジ）
  - Dagre.js によるレイアウト
  - ノード/エッジの SVG 描画
  - ノードクリックで GUI エディタへジャンプ（選択のみ）
- 目的
  - レイアウト品質・パフォーマンス・UXの感触を早期に確認

### フェーズ 2-β: 軽量編集機能

- 追加候補
  - ノード位置のドラッグによる手動微調整
  - ノードの追加・削除（JSONへの反映）
  - エッジ追加・削除（choice.target編集との連動）

> **意思決定ポイント A-4**: どこまでを Phase 2 としてこのプロジェクト内で実装するか。2-β を含めるか、別フェーズ（Phase 2.5）とするか。

---

## 7. リスクと制約

- ノード数が多いモデル（500ノード級）でのパフォーマンス
  - レイアウト計算時間
  - 描画・パン/ズーム時のFPS
- 既存 GUI エディタとの状態同期
  - グラフ側で編集した結果を JSON・GUI 双方に正しく反映する難易度
- UI複雑化
  - GraphPanel 上の設定項目が増えすぎると、学習コストが高くなる

---

## 8. 次のアクション案

1. この設計ドラフトのレビュー
   - 上記の意思決定ポイント A-1〜A-4 について方針確認
2. フェーズ 2-α のスパイク範囲の確定
   - 「閲覧専用ビュー」として最低限必要な機能の合意
3. 実装タスク分解
   - JSON→グラフ変換モジュール
   - Dagreラッパモジュール
   - GraphPanel UI 拡張
   - GuiEditorManager との連動
