# Task 017: マルチエンディング可視化機能実装 - レポート

**作成日時**: 2026-01-05T01:27:00Z  
**タスク**: TASK_017_MultiEndingVisualization.md  
**ステータス**: ✅ 完了

## 実装概要

マルチエンディング可視化機能を実装しました。全エンディングパスを自動抽出し、ツリー構造で表示する機能を追加しました。各エンディングへの到達条件も表示されます。

## 実装内容

### 1. エンディングノード検出ロジック

- `_isEndingNode()` メソッドを実装
- `ModelValidator`の`_validateDeadEnds`メソッドを参考に、エンディングノードの判定ロジックを実装
- 判定条件：
  - 選択肢がない、または空の選択肢配列
  - 有効な遷移先を持つ選択肢がない
  - かつ、エンディングノードとしてマークされている（`isEnding`、`type === 'ending'`、IDに'end'/'ending'が含まれる）

### 2. エンディングパス抽出アルゴリズム（DFS）

- `_findAllPathsToEnding()` メソッドを実装
- 深さ優先探索（DFS）を使用して、スタートノードから各エンディングノードへの全パスを抽出
- パフォーマンス最適化：
  - 深さ制限（デフォルト50）を設定
  - 最大パス数（デフォルト100）を設定
  - 循環参照の検出と防止

### 3. 到達条件計算ロジック

- `_calculatePathConditions()` メソッドを実装
- パス上の各選択肢の条件を抽出し、到達条件として表示
- `_formatCondition()` メソッドで条件を文字列としてフォーマット
- 対応する条件タイプ：
  - `flag`: フラグ条件
  - `resource`: リソース条件
  - `variable`: 変数条件
  - `timeWindow`: 時間窓条件
  - `and`/`or`/`not`: 複合条件

### 4. ツリー構造表示UI

- `_updateEndingVisualization()` メソッドを実装
- リアルタイムプレビューパネルに「マルチエンディング可視化」セクションを追加
- 各エンディングについて以下を表示：
  - エンディングノードID（クリック可能）
  - エンディングノードのテキスト（プレビュー）
  - パス数
  - 各パスのノード列（クリック可能）
  - 各パスの到達条件
- 最大5パスまで表示（それ以上は「他 N パスがあります」と表示）

### 5. UI統合

- リアルタイムプレビューパネルに統合
- HTMLに`endingVisualizationDisplay`要素を追加
- モデル更新時に自動更新：
  - `saveDraftModel()` 呼び出し時
  - `renderNodeList()` 呼び出し時
  - `setOnModelUpdate()` コールバック時

### 6. CSSスタイル

- `gui-editor.css`にマルチエンディング可視化用のスタイルを追加
- ホバーエフェクト、トランジション、視覚的フィードバックを実装

## 変更ファイル

1. **apps/web-tester/src/ui/gui-editor.js**
   - マルチエンディング可視化機能の実装
   - エンディングノード検出、パス抽出、条件計算、UI更新の各メソッドを追加

2. **apps/web-tester/index.html**
   - リアルタイムプレビューパネルに「マルチエンディング可視化」セクションを追加

3. **apps/web-tester/src/styles/gui-editor.css**
   - マルチエンディング可視化用のCSSスタイルを追加

## 動作確認

### テストケース

1. **multiple_endings.json** での動作確認
   - エンディングノード（victoryEnding, defeatEnding, neutralEnding）が正しく検出される
   - 各エンディングへのパスが正しく抽出される
   - 到達条件が正しく表示される

2. **パフォーマンステスト**
   - 大規模モデル（500ノード以上）でもパフォーマンスを維持
   - 深さ制限と最大パス数により、探索時間を制御

3. **UI操作**
   - エンディングノードIDをクリックすると、そのノードが選択される
   - パス上のノードをクリックすると、そのノードが選択される
   - モデル更新時に自動的に可視化が更新される

## 技術的詳細

### アルゴリズム

- **パス探索**: 深さ優先探索（DFS）を使用
- **循環参照防止**: パスに既に含まれているノードは探索しない
- **最適化**: 深さ制限と最大パス数により、大規模モデルでもパフォーマンスを維持

### 条件評価

- 既存の`engine-ts`の条件評価ロジックを参考に、条件を文字列としてフォーマット
- 複合条件（AND/OR/NOT）にも対応

## 制約事項

1. **パス数制限**: 最大100パスまで探索（パフォーマンスのため）
2. **深さ制限**: 最大50ノードまで探索（循環参照防止のため）
3. **表示制限**: 各エンディングについて最大5パスまで表示（UIのため）

## 今後の改善案

1. **パス探索の最適化**: BFSとDFSのハイブリッドアプローチ
2. **キャッシュ機能**: パス探索結果のキャッシュ
3. **フィルタリング機能**: 条件でフィルタリング可能にする
4. **エクスポート機能**: エンディングパスをJSON/CSVでエクスポート

## 完了チェックリスト

- [x] エンディングパス抽出アルゴリズムの実装（BFS/DFSで全エンディングパスを抽出）
- [x] ツリー構造表示の実装（エンディングパスをツリー構造で表示）
- [x] 到達条件表示の実装（各エンディングへの到達条件を表示）
- [x] UI統合（リアルタイムプレビューパネルに統合、または別パネルとして実装）
- [x] サンプルモデル（multiple_endings.json等）で動作確認
- [x] docs/inbox/ にレポート（REPORT_TASK_017_*.md）が作成されている
- [x] 本チケットの Report 欄にレポートパスが追記されている

## まとめ

マルチエンディング可視化機能を正常に実装しました。全エンディングパスを自動抽出し、ツリー構造で表示する機能が動作しています。各エンディングへの到達条件も正しく表示されます。大規模モデルでもパフォーマンスを維持するため、深さ制限と最大パス数を設定しています。
