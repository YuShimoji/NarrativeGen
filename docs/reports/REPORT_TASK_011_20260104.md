# Report: TASK_011_OpenSpecTimeWindow

**Timestamp**: 2026-01-04T20:30:00Z  
**Actor**: Worker  
**Type**: Task Report  
**Task**: docs/tasks/TASK_011_OpenSpecTimeWindow.md

## 実行サマリー

`docs/OpenSpec-WebTester.md`に`timeWindow`条件の仕様を追加し、他の条件（flag, resource, variable）と同レベルの詳細度で記載しました。条件システムのセクションを新規追加し、すべての条件タイプの仕様を包括的に記載しました。

## 実施内容

### 1. OpenSpec-WebTester.mdへの条件システムセクション追加

#### 追加位置
- セクション3「現在の主要機能と実装ステータス」の後、セクション4として新規追加
- 既存のセクション番号を調整（旧セクション4→5、旧セクション5→6、旧セクション6→7）

#### 追加内容

**セクション4: 条件システム** を新規作成し、以下の内容を記載：

1. **条件の種類** (4.1)
   - フラグ条件 (`flag`) の形式、評価ロジック、使用例
   - リソース条件 (`resource`) の形式、評価ロジック、使用例
   - 変数条件 (`variable`) の形式、評価ロジック、使用例
   - **時間ウィンドウ条件 (`timeWindow`)** の形式、評価ロジック、使用例
     - 形式: `{ type: 'timeWindow', start: number, end: number }`
     - 評価ロジック: `time >= start && time <= end` (両端を含む、inclusive)
     - 使用例と説明を記載

2. **複合条件** (4.2)
   - AND条件 (`and`) の形式、評価ロジック、使用例
   - OR条件 (`or`) の形式、評価ロジック、使用例
   - NOT条件 (`not`) の形式、評価ロジック、使用例

3. **条件の使用例** (4.3)
   - 時間ゲート付き選択肢の例
   - 複合条件（フラグ + リソース + 時間ウィンドウ）の例

4. **GUI エディタでの条件編集** (4.4)
   - 構造化フォームと文字列形式の両方をサポート
   - `timeWindow:5-10` または `time:5-10` 形式の記載

### 2. timeWindow条件の詳細仕様

#### 記載内容
- **型定義**: `{ type: 'timeWindow', start: number, end: number }`
- **評価ロジック**: `time >= start && time <= end` (両端を含む)
- **使用例**: 
  ```json
  { "type": "timeWindow", "start": 5, "end": 10 }
  ```
- **説明**: 現在の時間が 5 以上 10 以下（両端を含む）の場合に条件を満たすことを明記
- **具体例**: 時間が 5, 6, 7, 8, 9, 10 のいずれかの場合に条件を満たすことを記載

#### 他の条件との整合性
- flag, resource, variable 条件と同レベルの詳細度で記載
- 形式、評価ロジック、使用例の3要素をすべて記載
- エンジン実装（`Packages/engine-ts/src/`）との整合性を確認

### 3. エンジン実装との整合性確認

以下のエンジン実装を確認し、仕様書との整合性を保証：

- **型定義**: `Packages/engine-ts/src/types.ts`
  - `{ type: 'timeWindow'; start: number; end: number }` ✅
- **評価ロジック**: `Packages/engine-ts/src/index.ts`, `session-ops.ts`, `browser.ts`
  - `time >= cond.start && time <= cond.end` ✅
- **実例**: `models/examples/time_gated.json`
  - 正しい形式で使用されていることを確認 ✅

## 追加した内容の詳細

### timeWindow条件の仕様記載

```markdown
#### 時間ウィンドウ条件 (`timeWindow`)

現在の時間が指定された範囲内にあるかをチェックします。

- **形式**: `{ type: 'timeWindow', start: number, end: number }`
- **評価ロジック**: `time >= start && time <= end` (両端を含む、inclusive)
- **使用例**:
  ```json
  { "type": "timeWindow", "start": 5, "end": 10 }
  ```
  - 現在の時間が 5 以上 10 以下（両端を含む）の場合に条件を満たします
  - 例: 時間が 5, 6, 7, 8, 9, 10 のいずれかの場合に条件を満たします
```

### 複合条件の例（timeWindowを含む）

```json
{
  "type": "and",
  "conditions": [
    { "type": "flag", "key": "hasTicket", "value": true },
    { "type": "resource", "key": "gold", "op": ">=", "value": 100 },
    { "type": "timeWindow", "start": 8, "end": 12 }
  ]
}
```

## DoD達成状況

- [x] `docs/OpenSpec-WebTester.md`の条件セクションに`timeWindow`条件の仕様を追加
  - **結果**: セクション4「条件システム」を新規追加し、timeWindow条件を含むすべての条件タイプの仕様を記載
- [x] 条件の形式（`{ type: 'timeWindow', start: number, end: number }`）を記載
  - **結果**: 4.1節に形式を明記
- [x] 評価ロジック（`time >= start && time <= end`、両端を含む）を明記
  - **結果**: 評価ロジックと「両端を含む（inclusive）」を明記
- [x] 使用例を記載（他の条件と同レベル）
  - **結果**: 4.1節に使用例を記載、4.3節に実践的な例を追加
- [x] 他の条件（flag, resource, variable）と整合性のある記載形式
  - **結果**: すべての条件タイプを同じ形式（形式、評価ロジック、使用例）で記載
- [x] docs/inbox/ にレポート（REPORT_TASK_011_*.md）が作成されている
  - **結果**: 本レポートを作成
- [ ] 本チケットの Report 欄にレポートパスが追記されている
  - **次ステップ**: チケットを更新

## 補足情報

### 確認したファイル一覧

- `docs/OpenSpec-WebTester.md` - 主要仕様書（更新）
- `Packages/engine-ts/src/types.ts` - 型定義確認
- `Packages/engine-ts/src/index.ts` - 評価ロジック確認
- `Packages/engine-ts/src/session-ops.ts` - 評価ロジック確認
- `Packages/engine-ts/src/browser.ts` - 評価ロジック確認
- `models/examples/time_gated.json` - 実例確認
- `docs/reports/REPORT_TASK_010_20260104.md` - TASK_010の調査結果参照
- `docs/spreadsheet-format.md` - 他の条件の記載形式を参考
- `docs/NarrativeGen_Reference_Wiki.md` - 他の条件の記載形式を参考

### 技術的詳細

**評価ロジックの実装**:
```typescript
if (cond.type === 'timeWindow') {
  return time >= cond.start && time <= cond.end
}
```

**意味**:
- `timeWindow:5-10` は、現在の時間が 5 ≤ time ≤ 10 の範囲内の場合に条件を満たす
- 両端（5と10）を含む（inclusive）

**GUI エディタの互換性**:
- UIは `{ type: 'timeWindow', start: number, end: number }` 形式でエンジンに渡す
- 文字列形式 `timeWindow:5-10` または `time:5-10` もサポート
- エンジンはこの形式を期待しており、互換性がある

### 変更ファイル

- `docs/OpenSpec-WebTester.md`
  - セクション4「条件システム」を新規追加
  - セクション番号を調整（旧4→5、旧5→6、旧6→7）

---

**Status**: COMPLETED  
**Next Actions**: チケットのReport欄を更新
