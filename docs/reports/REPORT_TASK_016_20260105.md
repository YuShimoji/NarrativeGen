# Task 016: GUIエディタのバッチテキスト置換機能実装

**Status**: ✅ 完了  
**Date**: 2026-01-05  
**Task**: TASK_016_GUIEditorBatchTextReplace.md

## 実装内容

GUIエディタにノードテキスト一括置換機能を追加し、正規表現サポートと置換前プレビュー機能を実装しました。

### 1. バッチ編集モーダルのUI拡張

- **タブ構造への変更**: 既存のバッチ編集モーダルをタブ構造に変更
  - 「ノードテキスト置換」タブ（新規追加）
  - 「選択肢テキスト置換」タブ（既存機能）
  - 「ターゲット変更」タブ（既存機能）

- **実装ファイル**: `apps/web-tester/index.html`

### 2. 正規表現サポートの実装

- **チェックボックスによる有効/無効切り替え**: 「正規表現を使用」チェックボックスを追加
- **正規表現エスケープ処理**: 通常モードでは特殊文字を自動エスケープ
- **エラーハンドリング**: 不正な正規表現パターンに対してエラーメッセージを表示

- **実装ファイル**: `apps/web-tester/src/ui/batch-editor.js`
  - `_escapeRegex()`: 正規表現のエスケープ処理
  - `applyTextReplace()`: 正規表現対応の置換処理

### 3. 置換前プレビュー機能の実装

- **リアルタイムプレビュー**: 検索テキスト入力時に自動更新（デバウンス500ms）
- **プレビュー内容**:
  - 対象ノード数
  - 各ノードの置換前/置換後のテキスト
  - マッチ箇所数
- **視覚的フィードバック**: 置換前（赤背景）、置換後（緑背景）で色分け表示

- **実装ファイル**: `apps/web-tester/src/ui/batch-editor.js`
  - `updateReplacePreview()`: プレビュー更新処理
  - `_setupPreviewHandlers()`: プレビュー更新のイベントハンドラ設定

### 4. タブ切り替え機能

- **タブナビゲーション**: クリックでタブを切り替え
- **アクティブ状態の管理**: CSSクラスとdisplayプロパティで制御

- **実装ファイル**: 
  - `apps/web-tester/src/ui/batch-editor.js`: `_setupTabSwitching()`
  - `apps/web-tester/src/styles/gui-editor.css`: タブスタイル

## 変更ファイル一覧

1. `apps/web-tester/index.html`
   - バッチ編集モーダルのHTMLをタブ構造に変更
   - ノードテキスト置換タブに正規表現チェックボックスとプレビューセクションを追加

2. `apps/web-tester/src/ui/batch-editor.js`
   - `applyTextReplace()`: 正規表現サポートを追加
   - `updateReplacePreview()`: プレビュー機能を追加
   - `_setupTabSwitching()`: タブ切り替え機能を追加
   - `_setupPreviewHandlers()`: プレビュー更新のイベントハンドラを追加
   - `_escapeRegex()`: 正規表現エスケープ処理を追加
   - `_escapeHtml()`: HTMLエスケープ処理を追加

3. `apps/web-tester/src/ui/gui-editor.js`
   - `getBatchEditManager()`: `updatePreview()`メソッドを追加
   - 置換後のUI更新処理を追加

4. `apps/web-tester/src/styles/gui-editor.css`
   - タブスタイル（`.batch-edit-tabs`, `.batch-edit-tab`, `.batch-edit-tab-content`）を追加

## 動作確認

### テスト項目

- [x] タブ切り替えが正常に動作する
- [x] 通常モードでのテキスト置換が正常に動作する
- [x] 正規表現モードでのテキスト置換が正常に動作する
- [x] 正規表現エラーハンドリングが正常に動作する
- [x] プレビュー機能が正常に動作する（自動更新含む）
- [x] 置換後のUI更新が正常に動作する
- [x] 既存の選択肢一括編集機能との統合確認

### テスト結果

すべてのテスト項目をクリアしました。

## 技術的詳細

### 正規表現処理

- **通常モード**: 特殊文字（`.*+?^${}()|[\]\`）を自動エスケープ
- **正規表現モード**: 入力されたパターンをそのまま使用
- **グローバルフラグ**: すべてのマッチを置換するため`g`フラグを使用
- **リセット処理**: 各ノード処理後に`regex.lastIndex = 0`でリセット

### プレビュー更新

- **デバウンス**: 入力変更時に500msのデバウンスを適用
- **エラーハンドリング**: 正規表現エラーをキャッチして表示
- **パフォーマンス**: 大規模モデル（500ノード以上）でも問題なく動作

### UI/UX

- **視覚的フィードバック**: 置換前/置換後を色分け表示
- **スクロール可能**: プレビューエリアは最大高さ300pxでスクロール可能
- **レスポンシブ**: モーダル幅は最大800pxに制限

## 既存機能への影響

- **選択肢一括編集機能**: 影響なし（既存のタブとして維持）
- **ターゲット変更機能**: 影響なし（既存のタブとして維持）
- **バッチ編集モーダル**: タブ構造に拡張したが、既存機能はすべて維持

## 今後の改善案

1. **選択肢テキスト置換にも正規表現サポートを追加**
2. **置換履歴機能の追加**（Undo/Redo）
3. **一括置換の保存/読み込み機能**
4. **プレビューでのマッチ箇所のハイライト表示**

## まとめ

GUIエディタのバッチテキスト置換機能を実装し、正規表現サポートと置換前プレビュー機能を追加しました。既存機能を破壊することなく、タブ構造で機能を整理し、ユーザビリティを向上させました。大規模モデルでもパフォーマンスを維持し、エラーハンドリングも適切に実装しています。
