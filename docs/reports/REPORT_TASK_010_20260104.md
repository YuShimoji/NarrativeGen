# Report: TASK_010_TimeWindowConditionSpec

**Timestamp**: 2026-01-04T12:30:00Z  
**Actor**: Worker  
**Type**: Task Report  
**Task**: docs/tasks/TASK_010_TimeWindowConditionSpec.md

## 実行サマリー

`timeWindow`条件のエンジン仕様との最終整合確認を実施。仕様書と実装の整合性を確認し、不整合を記録した。

## 確認結果

### 1. エンジン側の実装確認

#### 型定義
- **ファイル**: `Packages/engine-ts/src/types.ts`
- **定義**: `{ type: 'timeWindow'; start: number; end: number }`
- **状態**: ✅ 明確に定義されている

#### 評価ロジック
- **ファイル**: 
  - `Packages/engine-ts/src/index.ts` (line 148-150)
  - `Packages/engine-ts/src/session-ops.ts` (line 69-70)
  - `Packages/engine-ts/src/browser.ts` (line 70-71)
- **実装**: `time >= cond.start && time <= cond.end`
- **意味**: 両端を含む（inclusive）範囲チェック
- **状態**: ✅ 全実装箇所で一貫している

### 2. UI側の実装確認

#### condition-effect-editor.js
- **ファイル**: `apps/web-tester/src/ui/condition-effect-editor.js`
- **サポート形式**:
  - 文字列形式: `time:start-end` または `timeWindow:start-end` (line 238, 421)
  - オブジェクト形式: `{ type: 'timeWindow', start, end }` (line 214-216, 352-358)
- **UI表示**: 開始時間と終了時間を入力する2つのフィールド（operatorは非表示）
- **状態**: ✅ エンジン仕様と互換性がある

### 3. 仕様書の確認結果

#### OpenSpec-WebTester.md
- **状態**: ❌ `timeWindow`条件に関する記述が**存在しない**
- **影響**: Web Testerの主要仕様書にtimeWindow条件の説明がない

#### spreadsheet-format.md
- **状態**: ⚠️ 部分的に記載
- **内容**: `timeWindow:<start>-<end>` 形式で記載 (line 55)
- **不足**: 評価ロジック（両端を含む）の明記がない

#### NarrativeGen_Reference_Wiki.md
- **状態**: ⚠️ 簡易的な記載のみ
- **内容**: `timeWindow:1-10` (時間範囲) と記載 (line 42)
- **不足**: 詳細な仕様（評価ロジック、境界の扱い）が不明

#### playthrough.schema.json
- **状態**: ✅ 型定義は明確
- **内容**: `{ type: 'timeWindow', start: number, end: number }` として定義
- **不足**: 評価ロジックの詳細は記載されていない（スキーマの範囲外）

#### openapi-spec.json
- **状態**: ✅ 型定義は明確
- **内容**: `start` と `end` は integer として定義
- **不足**: 評価ロジックの詳細は記載されていない（OpenAPI仕様の範囲外）

## 不整合の記録

### 不整合1: OpenSpec-WebTester.mdにtimeWindow条件の記載がない

**詳細**:
- `docs/OpenSpec-WebTester.md` は Web Tester の主要仕様書として機能しているが、`timeWindow`条件に関する記述が一切ない
- 他の条件（flag, resource, variable）については記載があるが、timeWindowのみ欠落

**影響範囲**:
- 開発者・ライターがWeb TesterのtimeWindow機能を理解する際の参照先がない
- 仕様書と実装の乖離が発生

**推奨対応**:
- `docs/OpenSpec-WebTester.md` に timeWindow条件の仕様を追加
- 少なくとも以下の内容を含める:
  - 条件の形式: `{ type: 'timeWindow', start: number, end: number }`
  - 評価ロジック: `time >= start && time <= end` (両端を含む)
  - 使用例

### 不整合2: 評価ロジック（両端を含む）の明記がない

**詳細**:
- エンジン実装では `time >= cond.start && time <= cond.end` として両端を含む（inclusive）評価を行っている
- しかし、仕様書にはこの評価ロジックの詳細が明記されていない
- `spreadsheet-format.md` や `NarrativeGen_Reference_Wiki.md` にも境界の扱いに関する説明がない

**影響範囲**:
- ライターが `timeWindow:5-10` と記述した場合、時間5と時間10が含まれるかどうかが仕様書から判断できない
- 実装を確認しないと正確な動作が分からない

**推奨対応**:
- 主要な仕様書（`OpenSpec-WebTester.md`, `spreadsheet-format.md`）に評価ロジックを明記
- 例: 「`timeWindow:5-10` は、現在の時間が5以上10以下（両端を含む）の場合に条件を満たします」

## 整合性確認結果

### ✅ 整合している点

1. **型定義**: エンジン、UI、スキーマ、OpenAPI仕様で一貫している
   - `{ type: 'timeWindow', start: number, end: number }`

2. **評価ロジック**: エンジン実装の全箇所で一貫している
   - `time >= cond.start && time <= cond.end`

3. **UI実装**: エンジン仕様と互換性がある
   - 文字列形式とオブジェクト形式の両方をサポート
   - エンジンが期待する形式でデータを生成

4. **実例**: `models/examples/time_gated.json` で正しい形式が使用されている

### ⚠️ 改善が必要な点

1. **仕様書の不足**: `OpenSpec-WebTester.md` に timeWindow条件の記載がない
2. **評価ロジックの明記不足**: 境界の扱い（両端を含む）が仕様書に明記されていない

## 推奨アクション

### 優先度: 中

1. **TASK_011**: `docs/OpenSpec-WebTester.md` に timeWindow条件の仕様を追加
   - 条件の形式、評価ロジック、使用例を記載
   - 他の条件（flag, resource, variable）と同レベルの詳細度で記載

2. **TASK_012**: `docs/spreadsheet-format.md` に timeWindow条件の評価ロジックを明記
   - 境界の扱い（両端を含む）を明記
   - 使用例を追加

## DoD達成状況

- [x] `docs/OpenSpec-WebTester.md`の`timeWindow`条件仕様を確認
  - **結果**: 記載がないことを確認
- [x] `Packages/engine-ts/src/`の`timeWindow`条件実装を確認
  - **結果**: 全実装箇所で一貫した実装を確認（`time >= start && time <= end`）
- [x] `apps/web-tester/src/ui/condition-effect-editor.js`の`timeWindow`条件UI実装を確認
  - **結果**: エンジン仕様と互換性がある実装を確認
- [x] 仕様と実装の整合性を確認し、不整合があれば記録
  - **結果**: 不整合2件を記録（仕様書の不足、評価ロジックの明記不足）
- [x] 不整合が見つかった場合、修正タスクを起票するか、既存Issueに紐付ける
  - **結果**: 修正タスク（TASK_011, TASK_012）を推奨アクションとして記録
- [x] docs/inbox/ にレポート（REPORT_TASK_010_*.md）が作成されている
  - **結果**: 本レポートを作成
- [ ] 本チケットの Report 欄にレポートパスが追記されている
  - **次ステップ**: チケットを更新

## 補足情報

### 確認したファイル一覧

- `Packages/engine-ts/src/types.ts` - 型定義
- `Packages/engine-ts/src/index.ts` - 評価ロジック
- `Packages/engine-ts/src/session-ops.ts` - 評価ロジック（キャッシュ付き）
- `Packages/engine-ts/src/browser.ts` - 評価ロジック（ブラウザ版）
- `apps/web-tester/src/ui/condition-effect-editor.js` - UI実装
- `docs/OpenSpec-WebTester.md` - 主要仕様書
- `docs/spreadsheet-format.md` - CSV形式仕様
- `docs/NarrativeGen_Reference_Wiki.md` - リファレンスWiki
- `models/schema/playthrough.schema.json` - JSONスキーマ
- `openapi-spec.json` - OpenAPI仕様
- `models/examples/time_gated.json` - 実例

### 技術的詳細

**評価ロジックの実装**:
```typescript
if (cond.type === 'timeWindow') {
  return time >= cond.start && time <= cond.end
}
```

**意味**:
- `timeWindow:5-10` は、現在の時間が 5 ≤ time ≤ 10 の範囲内の場合に条件を満たす
- 両端（5と10）を含む（inclusive）

**UI実装の互換性**:
- UIは `{ type: 'timeWindow', start: number, end: number }` 形式でエンジンに渡す
- エンジンはこの形式を期待しており、互換性がある

---

**Status**: COMPLETED  
**Next Actions**: チケット更新、修正タスク起票（必要に応じて）
